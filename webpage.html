<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Maritime Intelligence Platform</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="generated_port_data_from_json.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            color: #333;
        }

        .sidebar {
            width: 320px;
            background: white;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
            z-index: 1000;
            overflow-y: auto;
        }

        .sidebar-header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .sidebar-header h1 {
            font-size: 1.2rem;
            margin-bottom: 5px;
        }

        .sidebar-header p {
            font-size: 0.8rem;
            opacity: 0.9;
        }

        .main-navigation {
            background: #f8f9fa;
            padding: 15px 0;
            border-bottom: 1px solid #dee2e6;
        }

        .nav-item {
            display: block;
            width: 100%;
            padding: 12px 20px;
            background: none;
            border: none;
            text-align: left;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 500;
            color: #495057;
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
        }

        .nav-item:hover {
            background: #e9ecef;
            color: #2c3e50;
        }

        .nav-item.active {
            background: #667eea;
            color: white;
            border-left: 4px solid #2c3e50;
        }

        .market-data {
            flex: 1;
            padding: 10px;
        }

        .market-section {
            margin-bottom: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            overflow: hidden;
        }

        .market-header {
            background: #667eea;
            color: white;
            padding: 8px 12px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .market-content {
            padding: 10px;
            font-size: 0.8rem;
            display: none;
        }

        .market-content.active {
            display: block;
        }

        .market-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            padding: 3px 0;
        }

        .price-up { color: #28a745; }
        .price-down { color: #dc3545; }
        .price-stable { color: #6c757d; }

        .main-content {
            flex: 1;
            margin-left: 320px;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .container {
            flex: 1;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            margin: 20px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .page-content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            display: none;
        }

        .page-content.active {
            display: block;
        }

        .section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 20px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .input-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .fuel-grid {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 15px;
            align-items: end;
            margin-bottom: 15px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        .input-group label {
            font-weight: 500;
            color: #495057;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        .input-group input, .input-group select {
            padding: 10px 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        input, select, textarea {
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .scenario-item {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #dee2e6;
        }

        .scenario-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .scenario-title {
            font-weight: 600;
            color: #2c3e50;
            font-size: 1.1rem;
        }

        .scenario-type {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .scenario-type input[type="radio"] {
            margin-right: 5px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            margin: 5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-small {
            padding: 5px 10px;
            font-size: 0.8rem;
        }

        .results-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 30px;
        }

        .results-text {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            line-height: 1.6;
            overflow-y: auto;
            max-height: 500px;
        }

        .chart-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            border: 1px solid #e9ecef;
            height: 500px;
        }

        .table-container {
            overflow-x: auto;
            background: white;
            border-radius: 10px;
            margin-top: 20px;
            max-height: 500px;
            overflow-y: auto;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        .data-table th,
        .data-table td {
            padding: 8px 12px;
            text-align: center;
            border: 1px solid #dee2e6;
        }

        .data-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .data-table tr:nth-child(even) {
            background: #f8f9fa;
        }

        .data-table tr:hover {
            background: #e9ecef;
        }

        .positive {
            color: #28a745;
            font-weight: 600;
        }

        .negative {
            color: #dc3545;
            font-weight: 600;
        }

        .control-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin: 30px 0;
            flex-wrap: wrap;
        }

        .fuel-mix-display {
            background: #e7f3ff;
            border-left: 4px solid #667eea;
            padding: 10px;
            margin-top: 10px;
            font-size: 0.9rem;
            color: #2c3e50;
            border-radius: 0 8px 8px 0;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .checkbox-group input[type="checkbox"] {
            transform: scale(1.2);
        }

        .comparison-controls {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            align-items: end;
        }

        .hidden {
            display: none;
        }

        .pilot-fuel-section {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .price-sensitivity {
            background: #e8f5e8;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }

        .capex-item {
            background: #f0f0f0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .vessel-recommendations {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid #dee2e6;
        }

        .vessel-type {
            background: #e7f3ff;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 0 8px 8px 0;
        }

        .vessel-type h4 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .vessel-specs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .spec-item {
            background: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 0.9rem;
        }

        #map-container {
            height: 500px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .route-controls {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid #dee2e6;
        }

        .route-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }

        .chat-container {
            background: #f8f9fa;
            border-top: 1px solid #dee2e6;
            border-radius: 10px;
            margin: 20px 0 0 0;
        }

        .chat-header {
            background: #495057;
            color: white;
            padding: 15px;
            font-size: 1rem;
            font-weight: 500;
            border-radius: 10px 10px 0 0;
        }

        .chat-messages {
            height: 200px;
            padding: 15px;
            overflow-y: auto;
            font-size: 0.9rem;
        }

        .chat-input {
            display: flex;
            padding: 15px;
            gap: 10px;
        }

        .chat-input input {
            flex: 1;
            padding: 10px;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .chat-input button {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .chat-message {
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 8px;
        }

        .user-message {
            background: #667eea;
            color: white;
            margin-left: 20px;
        }

        .bot-message {
            background: #e9ecef;
            color: #495057;
            margin-right: 20px;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .alert {
            padding: 12px 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            border-left: 4px solid;
        }

        .alert-info {
            background-color: #d1ecf1;
            border-color: #bee5eb;
            color: #0c5460;
        }

        .alert-warning {
            background-color: #fff3cd;
            border-color: #ffeaa7;
            color: #856404;
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            border: 1px solid #dee2e6;
            text-align: center;
        }

        .card h3 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .card .value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #667eea;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 1.5em;
        }

        .home-content {
            max-width: 800px;
            margin: 0 auto;
        }

        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-top: 30px;
        }

        .feature-card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            border: 1px solid #dee2e6;
            text-align: center;
        }

        .feature-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            color: #667eea;
        }
        .rag-content h2 { /* Main Title */
            font-size: 1.5em;
            color: #2c3e50;
            border-bottom: 2px solid #667eea;
            padding-bottom: 5px;
            margin-top: 20px;
            margin-bottom: 15px;
        }
        .rag-content h3 { /* Main Section Headings (e.g., 1. Route Overview) */
            font-size: 1.3em;
            color: #34495e;
            margin-top: 20px;
            margin-bottom: 10px;
        }
        .rag-content h4 { /* Subsection Headings (e.g., 1.1 Geopolitical Risks) */
            font-size: 1.1em;
            color: #455a64;
            margin-top: 15px;
            margin-bottom: 8px;
            font-weight: bold;
        }
        .rag-content h5 { /* Sub-sub headings if used */
            font-size: 1em;
            color: #546e7a;
            margin-top: 10px;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .rag-content ul, .rag-content ol {
            margin-top: 5px;
            margin-bottom: 15px;
            padding-left: 20px;
        }
        .rag-content li {
            margin-bottom: 5px;
        }
        .rag-content p {
            margin-top: 0;
            margin-bottom: 10px;
            line-height: 1.5;
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 280px;
            }

            .main-content {
                margin-left: 280px;
            }

            .results-container {
                grid-template-columns: 1fr;
            }

            .input-grid {
                grid-template-columns: 1fr;
            }

            .fuel-grid {
                grid-template-columns: 1fr;
            }

            .container {
                margin: 10px;
            }

            .comparison-controls {
                flex-direction: column;
                align-items: stretch;
            }

            .grid {
                grid-template-columns: 1fr;
            }

            .feature-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h1>Maritime Intelligence</h1>
            <p>Comprehensive shipping platform</p>
        </div>
        
        <!-- Main Navigation -->
        <div class="main-navigation">
            <button class="nav-item active" onclick="showPage('home')">Home Page</button>
            <button class="nav-item" onclick="showPage('chartering')">Chartering Requirements</button>
            <button class="nav-item" onclick="showPage('voyage')">Voyage Optimization</button>
            <button class="nav-item" onclick="showPage('input')">Input & Analysis</button>
            <button class="nav-item" onclick="showPage('breakdown')">Yearly Breakdown</button>
            <button class="nav-item" onclick="showPage('optimization')">Fuel Mix Optimization</button>
        </div>
        
        <!-- Market Data -->
        <div class="market-data">
            <div class="market-section">
                <div class="market-header" onclick="toggleMarketSection('baltic')">
                    Baltic Exchange <span>▼</span>
                </div>
                <div class="market-content" id="baltic">
                    <div class="market-item">
                        <span>BDI</span>
                        <span class="price-up">1,247 ↑</span>
                    </div>
                    <div class="market-item">
                        <span>BCI</span>
                        <span class="price-down">2,156 ↓</span>
                    </div>
                    <div class="market-item">
                        <span>BPI</span>
                        <span class="price-up">1,089 ↑</span>
                    </div>
                    <div class="market-item">
                        <span>BSI</span>
                        <span class="price-stable">876 -</span>
                    </div>
                </div>
            </div>
            
            <div class="market-section">
                <div class="market-header" onclick="toggleMarketSection('fuel')">
                    Fuel Prices <span>▼</span>
                </div>
                <div class="market-content" id="fuel">
                    <div class="market-item">
                        <span>VLSFO</span>
                        <span class="price-up">$585/mt ↑</span>
                    </div>
                    <div class="market-item">
                        <span>MGO</span>
                        <span class="price-down">$720/mt ↓</span>
                    </div>
                    <div class="market-item">
                        <span>HFO</span>
                        <span class="price-up">$475/mt ↑</span>
                    </div>
                    <div class="market-item">
                        <span>LNG</span>
                        <span class="price-stable">$754/mt -</span>
                    </div>
                </div>
            </div>
            
            <div class="market-section">
                <div class="market-header" onclick="toggleMarketSection('commodities')">
                    Commodities <span>▼</span>
                </div>
                <div class="market-content" id="commodities">
                    <div class="market-item">
                        <span>Iron Ore</span>
                        <span class="price-down">$95.5/t ↓</span>
                    </div>
                    <div class="market-item">
                        <span>Coal</span>
                        <span class="price-up">$158/t ↑</span>
                    </div>
                    <div class="market-item">
                        <span>Crude Oil</span>
                        <span class="price-up">$78.5/bbl ↑</span>
                    </div>
                    <div class="market-item">
                        <span>Wheat</span>
                        <span class="price-stable">$6.2/bu -</span>
                    </div>
                </div>
            </div>
            
            <div class="market-section">
                <div class="market-header" onclick="toggleMarketSection('rates')">
                    Charter Rates <span>▼</span>
                </div>
                <div class="market-content" id="rates">
                    <div class="market-item">
                        <span>Capesize</span>
                        <span class="price-up">$22,500/day ↑</span>
                    </div>
                    <div class="market-item">
                        <span>Panamax</span>
                        <span class="price-down">$18,750/day ↓</span>
                    </div>
                    <div class="market-item">
                        <span>Supramax</span>
                        <span class="price-up">$15,200/day ↑</span>
                    </div>
                    <div class="market-item">
                        <span>Handysize</span>
                        <span class="price-stable">$12,800/day -</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="container">
            <div class="header">
                <h1 id="page-title">Maritime Intelligence Platform</h1>
                <p id="page-subtitle">Comprehensive vessel chartering, route optimization, and fuel analysis</p>
            </div>

            <!-- Home Page -->
            <div id="home-page" class="page-content active">
                <div class="home-content">
                    <div class="section">
                        <h2 class="section-title">Welcome to the Maritime Platform</h2>
                        <p style="font-size: 1.1rem; line-height: 1.6; margin-bottom: 20px;">
                            This comprehensive platform provides advanced tools for maritime professionals to optimize vessel operations and make informed chartering decisions. Navigate through different sections using the sidebar to access specific functionalities.
                        </p>
                    </div>

                    <div class="feature-grid">
                        <div class="feature-card">
                            <div class="feature-icon">📋</div>
                            <h3>Chartering Requirements</h3>
                            <p>Define your cargo specifications, route requirements, and commercial terms. Get intelligent vessel recommendations based on your specific needs.</p>
                        </div>
                        
                        <div class="feature-card">
                            <div class="feature-icon">🗺️</div>
                            <h3>Voyage Optimization</h3>
                            <p>Plan optimal routes with real-time distance calculations, fuel consumption estimates, and cost analysis. Visualize routes on interactive maps.</p>
                        </div>
                        
                        <div class="feature-card">
                            <div class="feature-icon">💹</div>
                            <h3>Market Intelligence</h3>
                            <p>Access real-time Baltic Exchange indices, fuel prices, commodity rates, and charter market data to make informed decisions.</p>
                        </div>
                        
                        <div class="feature-card">
                            <div class="feature-icon">📊</div>
                            <h3>Fuel Analysis</h3>
                            <p>Analyze maritime fuel strategies with detailed ROI calculations, yearly cost breakdowns, and fuel mix optimization.</p>
                        </div>
                    </div>

                    <div class="section">
                        <h3 class="section-title">How to Use This Platform</h3>
                        <ol style="font-size: 1rem; line-height: 1.8; margin-left: 20px;">
                            <li><strong>Start with Chartering Requirements:</strong> Define your cargo and route specifications to get vessel recommendations.</li>
                            <li><strong>Optimize Your Voyage:</strong> Plan routes, calculate distances, and estimate fuel costs with interactive mapping.</li>
                            <li><strong>Analyze Fuel Strategies:</strong> Use the Input & Analysis, Yearly Breakdown, and Fuel Mix Optimization sections to evaluate fuel strategies and financial outcomes.</li>
                            <li><strong>Stay Informed:</strong> Monitor market data in the sidebar for real-time pricing and market conditions.</li>
                        </ol>
                    </div>
                </div>

                <!-- Chat Section for Home -->
                <div class="chat-container">
                    <div class="chat-header">Maritime AI Assistant</div>
                    <div class="chat-messages" id="chat-messages-home">
                        <div class="chat-message bot-message">
                            Welcome! I'm your maritime AI assistant. I can help you with shipping routes, market conditions, vessel specifications, and platform navigation. How can I assist you today?
                        </div>
                    </div>
                    <div class="chat-input">
                        <input type="text" id="chat-input-home" placeholder="Ask me anything about shipping...">
                        <button onclick="sendMessage('home')">Send</button>
                    </div>
                </div>
            </div>

            <!-- Chartering Requirements Page -->
            <div id="chartering-page" class="page-content">
                <div class="section">
                    <h3 class="section-title">Cargo Information</h3>
                    <div class="grid">
                        <div class="input-group">
                            <label for="cargoType">Cargo Type</label>
                            <select id="cargoType" onchange="updateVesselRecommendations()">
                                <option value="">Select cargo type</option>
                                <option value="dry-bulk">Dry Bulk (coal, iron ore, grain)</option>
                                <option value="liquid-bulk">Liquid Bulk (crude oil, chemicals, LNG)</option>
                                <option value="breakbulk">Breakbulk/Project Cargo</option>
                                <option value="containers">Containers</option>
                                <option value="refrigerated">Refrigerated (reefer) Cargo</option>
                                <option value="hazardous">Hazardous/IMDG Class Cargo</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="cargoQuantity">Cargo Quantity</label>
                            <input type="number" id="cargoQuantity" placeholder="Enter quantity">
                        </div>
                        <div class="input-group">
                            <label for="cargoUnit">Unit</label>
                            <select id="cargoUnit">
                                <option value="MT">Metric Tons (MT)</option>
                                <option value="CBM">Cubic Meters (m³)</option>
                                <option value="BBL">Barrels (bbl)</option>
                                <option value="TEU">TEUs</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="stowageFactor">Stowage Factor (cu ft/ton)</label>
                            <input type="number" id="stowageFactor" placeholder="e.g., 45-55 for grain">
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h3 class="section-title">Route Information</h3>
                    <div class="grid">
                        <div class="input-group">
                            <label for="loadingPort">Loading Port</label>
                            <select id="loadingPort">
                                <option value="">Select loading port</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="dischargingPort">Discharging Port</label>
                            <select id="dischargingPort">
                                <option value="">Select discharging port</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="laycanStart">Laycan Start</label>
                            <input type="date" id="laycanStart">
                        </div>
                        <div class="input-group">
                            <label for="laycanEnd">Laycan End</label>
                            <input type="date" id="laycanEnd">
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h3 class="section-title">Commercial Terms</h3>
                    <div class="grid">
                        <div class="input-group">
                            <label for="freightTerms">Freight Terms</label>
                            <select id="freightTerms">
                                <option value="FIO">FIO (Free In/Out)</option>
                                <option value="FILO">FILO (Free In/Liner Out)</option>
                                <option value="LIFO">LIFO (Liner In/Free Out)</option>
                                <option value="Liner">Liner Terms</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="charterParty">Charter Party</label>
                            <select id="charterParty">
                                <option value="Gencon">Gencon</option>
                                <option value="Asbatankvoy">Asbatankvoy</option>
                                <option value="NYPE">NYPE</option>
                                <option value="Shelltime4">Shelltime 4</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="freightRate">Target Freight Rate</label>
                            <input type="number" id="freightRate" placeholder="USD per ton or lump sum">
                        </div>
                        <div class="input-group">
                            <label for="rateType">Rate Type</label>
                            <select id="rateType">
                                <option value="per-ton">USD per ton</option>
                                <option value="lump-sum">Lump sum</option>
                                <option value="daily">USD per day</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h3 class="section-title">Special Requirements</h3>
                    <div class="grid">
                        <div class="input-group">
                            <label for="specialRequirements">Special Requirements</label>
                            <textarea id="specialRequirements" rows="3" placeholder="Cranes/gear, tank coatings, temperature control, segregation, etc."></textarea>
                        </div>
                        <div class="input-group">
                            <label>Equipment Needs</label>
                            <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 5px;">
                                <label><input type="checkbox" id="geared"> Geared Vessel</label>
                                <label><input type="checkbox" id="cranes"> Own Cranes</label>
                                <label><input type="checkbox" id="reefer"> Refrigerated</label>
                                <label><input type="checkbox" id="coated"> Coated Tanks</label>
                            </div>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 20px;">
                        <button type="button" class="btn btn-primary" onclick="analyzeRequirements()">Analyze Requirements</button>
                    </div>
                </div>
                <div id="chartering-rag-results" class="rag-results-section hidden">
                    <h3>Chartering Insights</h3>
                    <div class="rag-content" id="chartering-briefing-content"></div>
                    <h4>Relevant Documents</h4>
                    <ul class="rag-doc-links" id="chartering-pdf-links-list"></ul>
                </div>

                <div id="vesselRecommendations" class="vessel-recommendations hidden">
                    <h3>Recommended Vessel Types</h3>
                    <div id="recommendationsList"></div>
                </div>

                <!-- Chat Section for Chartering -->
                <div class="chat-container">
                    <div class="chat-header">Maritime AI Assistant - Chartering</div>
                    <div class="chat-messages" id="chat-messages-chartering">
                        <div class="chat-message bot-message">
                            I can help you with vessel chartering requirements, cargo specifications, and commercial terms. What would you like to know?
                        </div>
                    </div>
                    <div class="chat-input">
                        <input type="text" id="chat-input-chartering" placeholder="Ask about chartering...">
                        <button onclick="sendMessage('chartering')">Send</button>
                    </div>
                </div>

                <button type="button" class="btn btn-primary" onclick="analyzeCharteringWithRAG()">Get Chartering Insights</button>

            </div>

            <!-- Voyage Optimization Page -->
            <div id="voyage-page" class="page-content">
                <div class="section">
                    <h3 class="section-title">Route Planning & Optimization</h3>
                    <div id="map-container"></div>
                    
                    <div class="route-controls">
                        <div class="grid">
                            <div class="input-group">
                                <label for="routeLoadPort">From Port</label>
                                <select id="routeLoadPort" onchange="updateRoute()">
                                    <option value="">Select departure port</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label for="routeDischargePort">To Port</label>
                                <select id="routeDischargePort" onchange="updateRoute()">
                                    <option value="">Select destination port</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label for="vesselSpeed">Vessel Speed (knots)</label>
                                <input type="number" id="vesselSpeed" value="14" min="8" max="25" onchange="updateRoute()">
                            </div>
                            <div class="input-group">
                                <label for="fuelConsumption">Fuel Consumption (MT/day)</label>
                                <input type="number" id="fuelConsumption" value="35" min="10" max="100" onchange="updateRoute()">
                            </div>
                        </div>
                        
                        <div class="route-info hidden" id="routeInfo">
                            <h4>Route Analysis</h4>
                            <div class="grid">
                                <div><strong>Distance:</strong> <span id="routeDistance">-</span> nautical miles</div>
                                <div><strong>Sailing Time:</strong> <span id="sailingTime">-</span> days</div>
                                <div><strong>Fuel Required:</strong> <span id="fuelRequired">-</span> MT</div>
                                <div><strong>Estimated Cost:</strong> <span id="estimatedCost">-</span> USD</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="voyage-rag-results" class="rag-results-section hidden">
                    <h3>Route & Market Insights</h3>
                    <div class="rag-content" id="voyage-briefing-content"></div>
                    <h4>Relevant Documents</h4>
                    <ul class="rag-doc-links" id="voyage-pdf-links-list"></ul>
                </div>

                <!-- Chat Section for Voyage -->
                <div class="chat-container">
                    <div class="chat-header">Maritime AI Assistant - Voyage Optimization</div>
                    <div class="chat-messages" id="chat-messages-voyage">
                        <div class="chat-message bot-message">
                            I can help you optimize routes, calculate distances, and estimate voyage costs. What route would you like to analyze?
                        </div>
                    </div>
                    <div class="chat-input">
                        <input type="text" id="chat-input-voyage" placeholder="Ask about voyage optimization...">
                        <button onclick="sendMessage('voyage')">Send</button>
                    </div>
                </div>
            </div>

            <!-- Input & Analysis Page -->
            <div id="input-page" class="page-content">
                <!-- Analysis Parameters -->
                <div class="section">
                    <h3 class="section-title">Analysis Parameters</h3>
                    <div class="input-grid">
                        <div class="input-group">
                            <label for="vesselLifespan">Vessel Lifespan (years)</label>
                            <input type="number" id="vesselLifespan" value="25" min="1" max="50">
                        </div>
                        <div class="input-group">
                            <label for="poolingRevenue">Pooling Price (USD/tCO2)</label>
                            <input type="number" id="poolingRevenue" value="50" min="0" step="0.01">
                        </div>
                        <div class="input-group">
                            <label for="discountRate">Discount Rate (%)</label>
                            <input type="number" id="discountRate" value="7" min="0" max="50" step="0.1">
                        </div>
                        <div class="input-group">
                            <label for="startYear">Start Year</label>
                            <input type="number" id="startYear" value="2028" min="2020" max="2060">
                        </div>
                    </div>
                </div>

                <!-- RAG Analysis Results Section -->
                <div id="rag-results" class="hidden"> <!-- Hidden by default until results are available -->
                    <h3>RAG Analysis Briefing</h3>
                    <div id="briefing-content">
                        <!-- The detailed textual analysis from the RAG pipeline will be inserted here by JavaScript -->
                    </div>
                    <h4>Relevant Documents</h4>
                    <ul id="pdf-links-list">
                        <!-- Links to relevant PDFs identified by the RAG pipeline will be inserted here by JavaScript -->
                    </ul>
                </div>
                <!-- The section you provided ends here, likely before the next <div class="section"> -->


                <!-- Baseline Scenario -->
                <div class="section">
                    <h3 class="section-title">Baseline Scenario</h3>
                    <div id="baselineFuelsContainer">
                        <!-- Baseline fuels will be added here -->
                    </div>
                    <button class="btn btn-success btn-small" onclick="addBaselineFuel()">+ Add Fuel</button>

                    <div class="input-grid" style="margin-top: 20px;">
                        <div class="input-group">
                            <label for="baselineESD">ESD Savings (%)</label>
                            <input type="number" id="baselineESD" value="0" min="0" max="100" step="0.1">
                        </div>
                        <div class="input-group">
                            <label for="baselineESDCapex">ESD CAPEX (USD)</label>
                            <input type="number" id="baselineESDCapex" value="0" min="0" step="1">
                        </div>
                        <div class="input-group">
                            <label for="baselineCapex">Additional CAPEX (USD)</label>
                            <input type="number" id="baselineCapex" value="0" min="0" step="1">
                        </div>
                        <div class="input-group">
                            <label for="baselineCapexDescription">CAPEX Description</label>
                            <input type="text" id="baselineCapexDescription" placeholder="e.g., Scrubber, BWTS">
                        </div>
                    </div>
                </div>

                <!-- Alternative Scenarios -->
                <div class="section">
                    <div class="scenario-header">
                        <h3 class="section-title">Alternative Scenarios</h3>
                        <div>
                            <button class="btn btn-success btn-small" onclick="addAlternativeScenario()">+ Add Scenario</button>
                            <button class="btn btn-danger btn-small" onclick="removeLastAlternativeScenario()">- Remove Last</button>
                        </div>
                    </div>
                    <div id="alternativeScenariosContainer">
                        <!-- Alternative scenarios will be added here -->
                    </div>
                </div>

                <div class="control-buttons">
                    <button class="btn btn-primary" onclick="calculateAndAnalyze()">Calculate Analysis</button>
                    <button class="btn btn-secondary" onclick="exportToExcel()">Export to Excel</button>
                </div>

                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p>Calculating analysis...</p>
                </div>

                <!-- Results Section -->
                <div id="resultsSection" class="hidden">
                    <div class="summary-cards">
                        <div class="card">
                            <h3>Best Case Total Cost</h3>
                            <div class="value" id="bestCaseCost">$0</div>
                        </div>
                        <div class="card">
                            <h3>Baseline Total Cost</h3>
                            <div class="value" id="baselineCost">$0</div>
                        </div>
                        <div class="card">
                            <h3>Total Savings</h3>
                            <div class="value" id="totalSavings">$0</div>
                        </div>
                        <div class="card">
                            <h3>Total Savings (Discounted)</h3>
                            <div class="value" id="totalSavingsDiscounted">$0</div>
                        </div>
                        <div class="card">
                            <h3>ROI</h3>
                            <div class="value" id="roi">0%</div>
                        </div>
                    </div>

                    <div class="results-container">
                        <div class="results-text" id="resultsText"></div>
                        <div class="chart-container">
                            <canvas id="mainChart"></canvas>
                        </div>
                    </div>

                    <!-- Cumulative Savings Analysis -->
                    <div class="section" style="margin-top: 30px;">
                        <h3 class="section-title">Cumulative Savings Analysis</h3>
                        <div class="alert alert-info">
                            <strong>Cumulative Savings:</strong> This section shows the cumulative savings over time, comparing both nominal and discounted values to help evaluate the long-term financial benefits of alternative fuel strategies.
                        </div>

                        <div class="chart-container" style="height: 500px;">
                            <div class="comparison-controls">
                                <div class="input-group">
                                    <label for="cumulativeScenario1">Scenario 1</label>
                                    <select id="cumulativeScenario1" onchange="createCumulativeSavingsChart()">
                                        <option value="baseline">Baseline</option>
                                    </select>
                                </div>
                                <div class="input-group">
                                    <label for="cumulativeScenario2">Scenario 2</label>
                                    <select id="cumulativeScenario2" onchange="createCumulativeSavingsChart()">
                                        <option value="bestCase">Best Case</option>
                                    </select>
                                </div>
                            </div>
                            <canvas id="cumulativeSavingsChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Chat Section for Input & Analysis -->
                <div class="chat-container">
                    <div class="chat-header">Maritime AI Assistant - Input & Analysis</div>
                    <div class="chat-messages" id="chat-messages-input">
                        <div class="chat-message bot-message">
                            I can assist with input parameters, baseline scenarios, and alternative scenario analysis. Ask me anything about fuel analysis!
                        </div>
                    </div>
                    <div class="chat-input">
                        <input type="text" id="chat-input-input" placeholder="Ask about fuel analysis inputs...">
                        <button onclick="sendMessage('input')">Send</button>
                    </div>
                </div>
            </div>

            <!-- Yearly Breakdown Page -->
            <div id="breakdown-page" class="page-content">
                <div class="section">
                    <h3 class="section-title">Yearly Breakdown Comparison</h3>

                    <div class="comparison-controls">
                        <div class="input-group">
                            <label for="breakdownScenario1">Scenario 1</label>
                            <select id="breakdownScenario1">
                                <option value="baseline">Baseline</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="breakdownScenario2">Scenario 2</label>
                            <select id="breakdownScenario2">
                                <option value="bestCase">Best Case</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="updateBreakdownComparison()">Update Comparison</button>
                    </div>

                    <div class="table-container">
                        <table class="data-table" id="yearlyTable">
                            <thead>
                                <tr>
                                    <th>Year</th>
                                    <th>Scenario 1 Bunker</th>
                                    <th>Scenario 1 Tier 1</th>
                                    <th>Scenario 1 Tier 2</th>
                                    <th>Scenario 1 Surplus</th>
                                    <th>Scenario 1 Total</th>
                                    <th>Scenario 1 Total (DCF)</th>
                                    <th>Scenario 2 Bunker</th>
                                    <th>Scenario 2 Tier 1</th>
                                    <th>Scenario 2 Tier 2</th>
                                    <th>Scenario 2 Surplus</th>
                                    <th>Scenario 2 Total</th>
                                    <th>Scenario 2 Total (DCF)</th>
                                    <th>Cost Difference</th>
                                    <th>Cost Difference (DCF)</th>
                                    <th>Cumulative DCF</th>
                                </tr>
                            </thead>
                            <tbody id="yearlyTableBody">
                                <!-- Data will be populated here -->
                            </tbody>
                        </table>
                    </div>

                    <div class="chart-container" style="margin-top: 20px;">
                        <canvas id="breakdownChart"></canvas>
                    </div>
                </div>

                <!-- Chat Section for Yearly Breakdown -->
                <div class="chat-container">
                    <div class="chat-header">Maritime AI Assistant - Yearly Breakdown</div>
                    <div class="chat-messages" id="chat-messages-breakdown">
                        <div class="chat-message bot-message">
                            I can help you understand yearly cost breakdowns and compare scenarios. What would you like to explore?
                        </div>
                    </div>
                    <div class="chat-input">
                        <input type="text" id="chat-input-breakdown" placeholder="Ask about yearly breakdowns...">
                        <button onclick="sendMessage('breakdown')">Send</button>
                    </div>
                </div>
            </div>

            <!-- Fuel Mix Optimization Page -->
            <div id="optimization-page" class="page-content">
                <div class="section">
                    <h3 class="section-title">Fuel Mix Optimization & Price Sensitivity</h3>

                    <div class="alert alert-info">
                        <strong>Best Case Analysis:</strong> This section provides a detailed breakdown of the optimal fuel mix for each year, along with a price sensitivity analysis. The optimal fuel mix is determined by selecting the lowest cost scenario for each year.
                    </div>

                    <div class="table-container">
                        <table class="data-table" id="optimizationTable">
                            <thead>
                                <tr>
                                    <th>Year</th>
                                    <th>Best Scenario</th>
                                    <th>Fuel Mix (Volume MT)</th>
                                    <th>Bunker Cost (USD)</th>
                                    <th>Penalties (USD)</th>
                                    <th>Surplus (USD)</th>
                                    <th>Total Cost (USD)</th>
                                </tr>
                            </thead>
                            <tbody id="optimizationTableBody">
                                <!-- Data will be populated here -->
                            </tbody>
                        </table>
                    </div>

                    <div class="price-sensitivity">
                        <h4>Price Sensitivity Analysis</h4>
                        <p>This analysis helps determine how much the price of a specific fuel needs to change for an alternative scenario to become the most cost-effective option for a given year.</p>
                        <div class="input-grid">
                            <div class="input-group">
                                <label for="sensitivityYear">Year</label>
                                <select id="sensitivityYear">
                                    <!-- Years will be populated -->
                                </select>
                            </div>
                            <div class="input-group">
                                <label for="sensitivityFromScenario">Current Best Scenario</label>
                                <select id="sensitivityFromScenario">
                                    <!-- Scenarios will be populated -->
                                </select>
                            </div>
                            <div class="input-group">
                                <label for="sensitivityToScenario">Target Scenario</label>
                                <select id="sensitivityToScenario">
                                    <!-- Scenarios will be populated -->
                                </select>
                            </div>
                            <button class="btn btn-primary" onclick="calculatePriceSensitivity()">Calculate Price Sensitivity</button>
                        </div>
                        <div id="sensitivityResults" class="hidden">
                            <!-- Results will be shown here -->
                        </div>
                    </div>
                </div>

                <!-- Chat Section for Fuel Mix Optimization -->
                <div class="chat-container">
                    <div class="chat-header">Maritime AI Assistant - Fuel Mix Optimization</div>
                    <div class="chat-messages" id="chat-messages-optimization">
                        <div class="chat-message bot-message">
                            I can assist with fuel mix optimization and price sensitivity analysis. Ask me anything about optimizing fuel strategies!
                        </div>
                    </div>
                    <div class="chat-input">
                        <input type="text" id="chat-input-optimization" placeholder="Ask about fuel optimization...">
                        <button onclick="sendMessage('optimization')">Send</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let map;
        let routeLine;
        let portMarkers = [];
        let currentPage = 'home';
        let routeCoordinates = null;
        let isFallback = false;
        let ACCEPTED_PORTS_DATA = null;
        let isAcceptedPortsDataLoaded = false;
        
                    // Function to load accepted ports data
            function loadAcceptedPortsData() {
                console.log("Attempting to load accepted ports data...");
                fetch('accepted_ports.json') // Assumes the file is in the same directory
                    .then(response => {
                        console.log("Fetch response for accepted ports:", response.status, response.ok);
                        if (!response.ok) {
                            if (response.status === 404) {
                                throw new Error("Accepted ports data file 'accepted_ports.json' not found.");
                            } else {
                                throw new Error(`Failed to load accepted ports data. HTTP error! status: ${response.status}`);
                            }
                        }
                        return response.json();
                    })
                    .then(data => {
                        ACCEPTED_PORTS_DATA = data;
                        isAcceptedPortsDataLoaded = true;
                        console.log("Accepted ports data loaded successfully:", ACCEPTED_PORTS_DATA.length, "ports");
                        // Re-initialize map markers if the map is already loaded
                        if (map) {
                            initializeMap(); // Or a dedicated function to redraw markers
                        }
                    })
                    .catch(error => {
                        console.error('Error loading accepted ports data:', error);
                        alert("Error: " + error.message);
                        isAcceptedPortsDataLoaded = true; // Mark as attempted
                    });
            }

        // Page navigation
        function showPage(pageId) {
            // Update navigation
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            event.target.classList.add('active');
            
            // Update content
            document.querySelectorAll('.page-content').forEach(content => content.classList.remove('active'));
            document.getElementById(pageId + '-page').classList.add('active');
            
            const titles = {
                'home': 'Maritime Charter & Optimization Platform',
                'chartering': 'Chartering Requirements',
                'voyage': 'Voyage Optimization',
                'input': 'Input & Analysis',             
                'breakdown': 'Yearly Breakdown',         
                'optimization': 'Fuel Mix Optimization'  
            };

            const subtitles = {
                'home': 'Comprehensive vessel chartering & route optimization',
                'chartering': 'Define cargo requirements and get vessel recommendations',
                'voyage': 'Route planning and voyage optimization',
                'input': 'Configure baseline scenarios and alternative fuel strategies', 
                'breakdown': 'Analyze yearly costs and compare scenarios',             
                'optimization': 'Optimize fuel mix for cost efficiency'                 
            };
            
            document.getElementById('page-title').textContent = titles[pageId];
            document.getElementById('page-subtitle').textContent = subtitles[pageId];
            
            currentPage = pageId;
            
            // Initialize or update map for voyage page
            if (pageId === 'voyage') {
                if (!map) {
                    setTimeout(initializeMap, 100);
                } else {
                    setTimeout(() => {
                        map.invalidateSize();
                        updateRoute(); // Ensure route is redrawn if ports are selected
                    }, 100);
                }
            }
        }
        
        // Inside populatePortSelectors function
        function populatePortSelectors() {
            const selectors = ['loadingPort', 'dischargingPort', 'routeLoadPort', 'routeDischargePort'];
            selectors.forEach(selectorId => {
                const selector = document.getElementById(selectorId);
                if (selector) {
                    selector.innerHTML = '<option value="">Select port</option>'; // Reset options
                    // --- CHANGE THIS LINE ---
                    // portData.forEach(port => {
                    generatedPortDataFromJson.forEach(port => {
                    // --- END CHANGE ---
                        const option = document.createElement('option');
                        option.value = port.code;
                        option.textContent = `${port.name}, ${port.country} (${port.code})`;
                        selector.appendChild(option);
                    });
                }
            });
        }
        // Add this helper function, preferably near other route/helper functions
        function findClosestAcceptedPort(targetPort, allPortData) {
            let closestPort = null;
            let minDistanceSq = Infinity; // Use squared distance to avoid Math.sqrt
            const targetLat = targetPort.lat;
            const targetLng = targetPort.lng;

            allPortData.forEach(port => {
                // Check if the port is accepted
                if (port.is_accepted === true && port.code !== targetPort.code) { // Avoid selecting the target port itself if it happens to be marked accepted (shouldn't be needed, but safe)
                    const deltaLat = targetLat - port.lat;
                    const deltaLng = targetLng - port.lng;
                    // Calculate squared Euclidean distance (approximation)
                    const distanceSq = deltaLat * deltaLat + deltaLng * deltaLng;

                    if (distanceSq < minDistanceSq) {
                        minDistanceSq = distanceSq;
                        closestPort = port;
                    }
                }
            });

            return closestPort; // Returns the port object or null if none found
        }
        // Initialize map
        function initializeMap() {
            // No need to wait for separate accepted ports data anymore
            // if (!isAcceptedPortsDataLoaded) { ... }

            if (!map) {
                map = L.map('map-container').setView([20, 0], 2);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap contributors',
                    maxZoom: 18,
                    tileSize: 256
                }).addTo(map);
            }

            // Clear existing markers
            portMarkers.forEach(marker => map.removeLayer(marker));
            portMarkers = [];

            // Define icons based on acceptance status
            const acceptedPortIcon = L.divIcon({
                className: 'custom-port-marker',
                html: '<div style="background-color: green; width: 10px; height: 10px; border-radius: 50%; border: 2px solid white;"></div>',
                iconSize: [14, 14],
                iconAnchor: [7, 7]
            });

            const unacceptedPortIcon = L.divIcon({
                className: 'custom-port-marker',
                html: '<div style="background-color: black; width: 10px; height: 10px; border-radius: 50%; border: 2px solid white;"></div>',
                iconSize: [14, 14],
                iconAnchor: [7, 7]
            });

            // Iterate through the generated port data and add markers
            generatedPortDataFromJson.forEach(port => {
                // Use the embedded 'is_accepted' flag
                const isAccepted = port.is_accepted === true;
                const markerIcon = isAccepted ? acceptedPortIcon : unacceptedPortIcon;

                const marker = L.marker([port.lat, port.lng], { icon: markerIcon }).addTo(map);

                const statusText = isAccepted ? "(Panamax Accepted)" : "(Panamax Not Accepted)";
                marker.bindPopup(`<b>${port.name}</b><br>${port.country}<br>Code: ${port.code}<br>${statusText}<br>${port.info || ''}`);

                portMarkers.push(marker);
            });

            updateRoute(); // Trigger route update if ports are already selected
        }
        
        // Toggle market sections
        function toggleMarketSection(sectionId) {
            const content = document.getElementById(sectionId);
            const header = content.previousElementSibling;
            const arrow = header.querySelector('span');
            
            if (content.classList.contains('active')) {
                content.classList.remove('active');
                arrow.textContent = '▼';
            } else {
                content.classList.add('active');
                arrow.textContent = '▲';
            }
        }
        
        // Update market data
        function updateMarketData() {
            const priceElements = document.querySelectorAll('.market-item span:last-child');
            priceElements.forEach(element => {
                if (Math.random() > 0.7) {
                    const change = Math.random() > 0.5 ? '↑' : '↓';
                    const className = change === '↑' ? 'price-up' : 'price-down';
                    element.className = className;
                    element.textContent = element.textContent.replace(/[↑↓-]/, change);
                }
            });
        }
        
        // Vessel recommendations
        function updateVesselRecommendations() {
            const cargoType = document.getElementById('cargoType').value;
            if (!cargoType) return;
            
            const recommendations = {
                'dry-bulk': {
                    types: ['Bulk Carrier'],
                    sizes: ['Handysize (10,000-35,000 DWT)', 'Supramax (50,000-60,000 DWT)', 'Panamax (60,000-80,000 DWT)', 'Capesize (150,000+ DWT)'],
                    features: ['Self-unloading capability', 'Hold washing systems', 'Cargo hold ventilation']
                },
                'liquid-bulk': {
                    types: ['Oil Tanker', 'Chemical Tanker', 'LNG Carrier'],
                    sizes: ['Handy (25,000-45,000 DWT)', 'MR (45,000-55,000 DWT)', 'LR (80,000-120,000 DWT)', 'VLCC (200,000+ DWT)'],
                    features: ['Coated cargo tanks', 'Inert gas system', 'Specialized pumping systems']
                },
                'breakbulk': {
                    types: ['General Cargo Ship', 'Multi-purpose Vessel', 'Heavy Lift Vessel'],
                    sizes: ['Small (5,000-15,000 DWT)', 'Medium (15,000-35,000 DWT)', 'Large (35,000+ DWT)'],
                    features: ['Own cranes and derricks', 'Tweendeck capability', 'Heavy lift capacity']
                },
                'containers': {
                    types: ['Container Ship'],
                    sizes: ['Feeder (500-1,500 TEU)', 'Feedermax (1,500-3,000 TEU)', 'Panamax (3,000-5,000 TEU)', 'ULCV (15,000+ TEU)'],
                    features: ['Cell guides', 'Reefer plugs', 'Container lashing systems']
                },
                'refrigerated': {
                    types: ['Reefer Ship', 'Container Ship with Reefer'],
                    sizes: ['Small (200-500 TEU)', 'Medium (500-1,200 TEU)', 'Large (1,200+ TEU)'],
                    features: ['Temperature control systems', 'Controlled atmosphere', 'Cargo monitoring']
                },
                'hazardous': {
                    types: ['Chemical Tanker', 'Specialized Cargo Ship'],
                    sizes: ['Various based on cargo type'],
                    features: ['IMO certified', 'Specialized handling equipment', 'Emergency response systems']
                }
            };
            
            const recommendation = recommendations[cargoType];
            if (recommendation) {
                displayVesselRecommendations(recommendation);
            }
        }
        
        function displayVesselRecommendations(recommendation) {
            const container = document.getElementById('vesselRecommendations');
            const listContainer = document.getElementById('recommendationsList');
            
            listContainer.innerHTML = '';
            
            recommendation.types.forEach(type => {
                const vesselDiv = document.createElement('div');
                vesselDiv.className = 'vessel-type';
                
                vesselDiv.innerHTML = `
                    <h4>${type}</h4>
                    <p><strong>Typical Sizes:</strong> ${recommendation.sizes.join(', ')}</p>
                    <div class="vessel-specs">
                        ${recommendation.features.map(feature => 
                            `<div class="spec-item">• ${feature}</div>`
                        ).join('')}
                    </div>
                `;
                
                listContainer.appendChild(vesselDiv);
            });
            
            container.classList.remove('hidden');
        }
        
        function analyzeRequirements() {
            const cargoType = document.getElementById('cargoType').value;
            const quantity = document.getElementById('cargoQuantity').value;
            const loadPort = document.getElementById('loadingPort').value;
            const dischargePort = document.getElementById('dischargingPort').value;
            
            if (!cargoType || !quantity || !loadPort || !dischargePort) {
                alert('Please fill in all required fields');
                return;
            }
            
            showPage('voyage');
            document.getElementById('routeLoadPort').value = loadPort;
            document.getElementById('routeDischargePort').value = dischargePort;
            updateRoute();
            
            alert('Analysis complete! Check Voyage Optimization for route details.');
        }
        
        // Route functions
        function updateRoute() {
            // Ensure map is initialized
            if (!map) {
                console.warn("Map not initialized yet. Cannot update route.");
                return;
            }
            const loadPortCodeElement = document.getElementById('routeLoadPort');
            const dischargePortCodeElement = document.getElementById('routeDischargePort');
            if (!loadPortCodeElement || !dischargePortCodeElement) {
                console.error("Route port select elements not found.");
                return;
            }
            const loadPortCode = loadPortCodeElement.value;
            const dischargePortCode = dischargePortCodeElement.value;
            // Clear existing route if inputs are invalid
            if (!loadPortCode || !dischargePortCode || loadPortCode === dischargePortCode) {
                clearCurrentRoute();
                hideRouteInfo();
                return;
            }
            // Find port data using the generatedPortDataFromJson array
            const loadPort = generatedPortDataFromJson.find(p => p.code === loadPortCode);
            const dischargePort = generatedPortDataFromJson.find(p => p.code === dischargePortCode);
            if (!loadPort || !dischargePort) {
                console.error("Port data not found for selected codes:", loadPortCode, dischargePortCode);
                clearCurrentRoute();
                hideRouteInfo();
                return;
            }
            // Remove any existing route line from the map
            clearCurrentRoute();

            // Pass the original ports to drawRoute, it will handle finding effective ports and route data
            // Pass null for routeCoordinates initially, and false for isFallback
            drawRoute(loadPort, dischargePort, null, false);
        }

        // --- Add these helper functions near updateRoute or with other route functions ---

        // Helper to clear the current route from the map
        function clearCurrentRoute() {
            if (routeLine) {
                map.removeLayer(routeLine);
                routeLine = null;
            }
        }

        // Helper to hide the route info panel
        function hideRouteInfo() {
            const routeInfoElement = document.getElementById('routeInfo');
            if (routeInfoElement) {
                routeInfoElement.classList.add('hidden');
            }
        }

        // Helper function to draw the route on the map
        function drawRoute(loadPort, dischargePort) {
            // Clear any existing route
            clearCurrentRoute();
            hideRouteInfo(); // Hide previous route info/messages

            const isLoadPortAccepted = loadPort.is_accepted === true;
            const isDischargePortAccepted = dischargePort.is_accepted === true;

            let effectiveLoadPort = loadPort;
            let effectiveDischargePort = dischargePort;
            let infoMessage = "";

            // --- Logic to determine effective ports ---
            if (!isLoadPortAccepted && !isDischargePortAccepted) {
                // Case 3: Both unaccepted
                const closestToLoad = findClosestAcceptedPort(loadPort, generatedPortDataFromJson);
                const closestToDischarge = findClosestAcceptedPort(dischargePort, generatedPortDataFromJson);
                if (closestToLoad && closestToDischarge) {
                    effectiveLoadPort = closestToLoad;
                    effectiveDischargePort = closestToDischarge;
                    infoMessage = `Note: Routing via closest accepted ports. Loading at ${effectiveLoadPort.name} (${effectiveLoadPort.code}) instead of ${loadPort.name} (${loadPort.code}) and discharging at ${effectiveDischargePort.name} (${effectiveDischargePort.code}) instead of ${dischargePort.name} (${dischargePort.code}). These intermediate ports may not accept Panamax vessels.`;
                } else {
                    infoMessage = "Error: Could not find suitable accepted ports for routing.";
                    displayRouteMessage(infoMessage); // Show error message
                    return;
                }

            } else if (!isLoadPortAccepted) {
                // Case 2a: Load unaccepted, Discharge accepted
                const closestToLoad = findClosestAcceptedPort(loadPort, generatedPortDataFromJson);
                if (closestToLoad) {
                    effectiveLoadPort = closestToLoad;
                    infoMessage = `Note: Routing via closest accepted port. Loading at ${effectiveLoadPort.name} (${effectiveLoadPort.code}) instead of ${loadPort.name} (${loadPort.code}). This intermediate port may not accept Panamax vessels.`;
                } else {
                    infoMessage = "Error: Could not find a suitable accepted port near the loading port.";
                    displayRouteMessage(infoMessage);
                    return;
                }

            } else if (!isDischargePortAccepted) {
                // Case 2b: Load accepted, Discharge unaccepted
                const closestToDischarge = findClosestAcceptedPort(dischargePort, generatedPortDataFromJson);
                if (closestToDischarge) {
                    effectiveDischargePort = closestToDischarge;
                    infoMessage = `Note: Routing via closest accepted port. Discharging at ${effectiveDischargePort.name} (${effectiveDischargePort.code}) instead of ${dischargePort.name} (${dischargePort.code}). This intermediate port may not accept Panamax vessels.`;
                } else {
                    infoMessage = "Error: Could not find a suitable accepted port near the discharging port.";
                    displayRouteMessage(infoMessage);
                    return;
                }
            }
            // Case 1: Both accepted -> effective ports are the same, no infoMessage needed.

            // --- Fetch and Draw Route ---
            let routeCoordinates = null;
            let isFallback = false;

            // Check if pre-calculated route data is loaded
            if (isSeaRouteDataLoaded && CALCULATED_SEA_ROUTES) {
                const routeKeyAB = `${effectiveLoadPort.code}-${effectiveDischargePort.code}`;
                const routeKeyBA = `${effectiveDischargePort.code}-${effectiveLoadPort.code}`;

                if (CALCULATED_SEA_ROUTES[routeKeyAB]) {
                    routeCoordinates = CALCULATED_SEA_ROUTES[routeKeyAB];
                    console.log(`Found pre-calculated route for ${routeKeyAB}`);
                } else if (CALCULATED_SEA_ROUTES[routeKeyBA]) {
                    // Reverse the coordinates if the route was stored the other way
                    routeCoordinates = CALCULATED_SEA_ROUTES[routeKeyBA].slice().reverse();
                    console.log(`Found and reversed pre-calculated route for ${routeKeyBA}`);
                } else {
                    console.warn(`No pre-calculated route found for ${routeKeyAB} or ${routeKeyBA}`);
                    isFallback = true;
                }
            } else if (isSeaRouteDataLoaded) {
                console.warn("Sea route data loaded but appears empty/invalid.");
                isFallback = true;
            } else {
                console.log("Sea route data still loading, using fallback.");
                isFallback = true; // Or wait/retry if preferred
            }

            // Fallback to straight line if no route found or data not ready
            if (isFallback || !routeCoordinates || routeCoordinates.length < 2) {
                console.warn("Using straight line as fallback for route display.");
                routeCoordinates = [[effectiveLoadPort.lng, effectiveLoadPort.lat], [effectiveDischargePort.lng, effectiveDischargePort.lat]];
                isFallback = true;
            }

            // --- Draw the Route and Display Info ---
            if (!routeCoordinates || routeCoordinates.length < 2) {
                console.error("Invalid route coordinates to draw.");
                displayRouteMessage("Error: Unable to display route.");
                return;
            }

            // Draw the polyline on the map
            const leafletCoordinates = routeCoordinates.map(coord => [coord[1], coord[0]]); // Convert [lng,lat] to [lat,lng]
            routeLine = L.polyline(leafletCoordinates, {
                color: isFallback ? '#cccccc' : '#667eea',
                weight: isFallback ? 2 : 3,
                opacity: isFallback ? 0.6 : 0.8,
                dashArray: isFallback ? '5, 5' : null
            }).addTo(map);

            map.fitBounds(routeLine.getBounds(), { padding: [50, 50] });

            // Calculate and display route details (distance, time, etc.)
            displayRouteInfo(effectiveLoadPort, effectiveDischargePort); // Implement this function to calculate based on drawn line or coordinates

            // Display the informational message about effective ports
            displayRouteMessage(infoMessage);

            // Show the route info panel
            document.getElementById('routeInfo')?.classList.remove('hidden');

            analyzeVoyageWithRAG();

        }

        // --- Helper function to display the informational message ---
        function displayRouteMessage(message) {
            const routeInfoElement = document.getElementById('routeInfo');
            if (routeInfoElement) {
                // Find or create the paragraph for the message
                let messagePara = document.getElementById('intermediate-port-info');
                if (!messagePara) {
                    messagePara = document.createElement('p');
                    messagePara.id = 'intermediate-port-info';
                    messagePara.style.marginTop = '10px';
                    messagePara.style.fontStyle = 'italic';
                    // Append it, e.g., at the end of the route info div or before the grid
                    const gridElement = routeInfoElement.querySelector('.grid'); // Assuming .grid holds distance/time/fuel
                    if (gridElement) {
                        routeInfoElement.insertBefore(messagePara, gridElement.nextSibling); // Insert after grid
                    } else {
                        routeInfoElement.appendChild(messagePara); // Fallback
                    }
                }
                messagePara.textContent = message || ""; // Clear if message is empty/null
            }
        }

        // --- Helper function to calculate/display route details ---
        function displayRouteInfo(loadPort, dischargePort) {
            // Calculate distance using the actual route coordinates if available and valid
            let distanceInNm = 0;
            if (routeLine) {
                // Approximate distance by summing segments (Leaflet's distance calculation)
                const latlngs = routeLine.getLatLngs();
                for (let i = 1; i < latlngs.length; i++) {
                    // Leaflet's distanceTo returns meters, convert to nautical miles (1 NM = 1852 meters)
                    distanceInNm += latlngs[i-1].distanceTo(latlngs[i]) / 1852;
                }
                distanceInNm = Math.round(distanceInNm);
            } else {
                // Fallback to Haversine if routeLine not available (shouldn't happen normally here)
                const R = 3440; // Earth's radius in nautical miles
                const lat1 = loadPort.lat * Math.PI / 180;
                const lat2 = dischargePort.lat * Math.PI / 180;
                const deltaLat = (dischargePort.lat - loadPort.lat) * Math.PI / 180;
                const deltaLng = (dischargePort.lng - loadPort.lng) * Math.PI / 180;
                const a = Math.sin(deltaLat/2) * Math.sin(deltaLat/2) +
                        Math.cos(lat1) * Math.cos(lat2) *
                        Math.sin(deltaLng/2) * Math.sin(deltaLng/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                distanceInNm = Math.round(R * c);
            }

            const speed = parseFloat(document.getElementById('vesselSpeed').value) || 14;
            const fuelConsumption = parseFloat(document.getElementById('fuelConsumption').value) || 35;
            const sailingTime = Math.round((distanceInNm / speed / 24) * 10) / 10;
            const fuelRequired = Math.round(sailingTime * fuelConsumption);
            const estimatedCost = Math.round(fuelRequired * 600); // Assuming $600/MT fuel cost

            document.getElementById('routeDistance').textContent = distanceInNm.toLocaleString();
            document.getElementById('sailingTime').textContent = sailingTime;
            document.getElementById('fuelRequired').textContent = fuelRequired.toLocaleString();
            document.getElementById('estimatedCost').textContent = '$' + estimatedCost.toLocaleString();

            // Ensure the route info panel is visible (might be redundant if done in drawRoute)
            document.getElementById('routeInfo')?.classList.remove('hidden');
        }


        // --- Helper function to draw the polyline on the map ---
        function drawRouteOnMap(loadPort, dischargePort, routeCoordinates, isFallback) {
            clearCurrentRoute(); // Clear any existing route

            const leafletCoordinates = routeCoordinates
                .filter(coord => coord && coord.length >= 2)
                .map(coord => [coord[1], coord[0]]); // Convert [lng,lat] to [lat,lng]

            if (leafletCoordinates.length >= 2) {
                routeLine = L.polyline(leafletCoordinates, {
                    color: isFallback ? '#cccccc' : '#667eea',
                    weight: isFallback ? 2 : 3,
                    opacity: isFallback ? 0.6 : 0.8,
                    dashArray: isFallback ? '5, 5' : null
                }).addTo(map);

                map.fitBounds(routeLine.getBounds(), { padding: [50, 50] });
            } else {
                console.error("Processed route coordinates are invalid or empty for drawing.");
                clearCurrentRoute();
            }
        } 
        function calculateRouteDetails(loadPort, dischargePort) {
            const R = 3440; // Earth's radius in nautical miles
            const lat1 = loadPort.lat * Math.PI / 180;
            const lat2 = dischargePort.lat * Math.PI / 180;
            const deltaLat = (dischargePort.lat - loadPort.lat) * Math.PI / 180;
            const deltaLng = (dischargePort.lng - loadPort.lng) * Math.PI / 180;
            
            const a = Math.sin(deltaLat/2) * Math.sin(deltaLat/2) +
                    Math.cos(lat1) * Math.cos(lat2) *
                    Math.sin(deltaLng/2) * Math.sin(deltaLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            const distance = Math.round(R * c);
            
            const speed = parseFloat(document.getElementById('vesselSpeed').value) || 14;
            const fuelConsumption = parseFloat(document.getElementById('fuelConsumption').value) || 35;
            const sailingTime = Math.round((distance / speed / 24) * 10) / 10;
            const fuelRequired = Math.round(sailingTime * fuelConsumption);
            const estimatedCost = Math.round(fuelRequired * 600);
            
            document.getElementById('routeDistance').textContent = distance.toLocaleString();
            document.getElementById('sailingTime').textContent = sailingTime;
            document.getElementById('fuelRequired').textContent = fuelRequired.toLocaleString();
            document.getElementById('estimatedCost').textContent = '$' + estimatedCost.toLocaleString();
            
            document.getElementById('routeInfo').classList.remove('hidden');
        }
        
        // Chat functionality
        function sendMessage(pageId) {
            const inputElement = document.getElementById(`chat-input-${pageId}`);
            const message = inputElement.value.trim();
            inputElement.value = ''; // Clear the input field

            if (!message) {
                return; // Don't send empty messages
            }

            // Display the user's message immediately
            addChatMessage(message, 'user', pageId);

            // Send the query to the RAG API
            sendQueryToRAG(message, pageId);
        }
        
        function sendQueryToRAG(query, pageId) {
            // --- CONFIGURATION ---
            const RAG_API_URL = 'http://127.0.0.1:5000/api/query';

            // Display a "thinking" indicator
            const thinkingMessageId = `thinking-${Date.now()}`;
            addTemporaryMessage("Consulting maritime intelligence...", 'bot', pageId, thinkingMessageId);

            // --- PREPARE REQUEST DATA ---
            // Option 1: Send as a general 'question' (requires server-side handling)
            let requestData = { question: query };

            // Option 2: Send structured data (example - adapt based on context)
            // If you want to include context like selected ports, get them:
            /*
            const loadPortSelect = document.getElementById('routeLoadPort');
            const dischargePortSelect = document.getElementById('routeDischargePort');
            const loadPortText = loadPortSelect ? loadPortSelect.options[loadPortSelect.selectedIndex]?.text || "Not Selected" : "Unknown";
            const dischargePortText = dischargePortSelect ? dischargePortSelect.options[dischargePortSelect.selectedIndex]?.text || "Not Selected" : "Unknown";

            requestData = {
                origin_port: loadPortText,
                destination_port: dischargePortText,
                ship_type: "General Inquiry",
                dwt: "N/A",
                length: "N/A",
                width: "N/A",
                draft: "N/A",
                fuel_type: "N/A",
                cargo: query, // Put the chat message in the cargo field
                timeframe: "N/A"
            };
            */
            // --- END PREPARE REQUEST DATA ---

            // --- SEND REQUEST ---
            fetch(RAG_API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                    // Add 'Authorization' header here if your RAG API requires an API key
                    // 'Authorization': 'Bearer YOUR_API_KEY_HERE'
                },
                body: JSON.stringify(requestData)
            })
            .then(response => {
                // Remove the "thinking" indicator once we get a response (success or error)
                removeTemporaryMessage(thinkingMessageId);

                if (!response.ok) {
                    console.error(`RAG API request failed: ${response.status} ${response.statusText}`);
                    throw new Error(`API Error: ${response.status} - ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                console.log("Received data from RAG API:", data);

                // --- HANDLE API RESPONSE ---
                if (data.error) {
                    addChatMessage(`RAG Pipeline Error: ${data.error}`, 'bot', pageId);
                    return;
                }

                // Extract the main text response ('briefing')
                const ragBriefing = data.briefing || "Sorry, I couldn't formulate a response based on the available data.";

                // Display the main response
                addChatMessage(ragBriefing, 'bot', pageId);

                // Handle the list of relevant PDF files, if provided
                if (data.pdf_files && Array.isArray(data.pdf_files) && data.pdf_files.length > 0) {
                    let pdfLinksHtml = "<b>Relevant Documents:</b><ul>";
                    data.pdf_files.forEach(pdfFileName => {
                        // IMPORTANT: Adjust the path prefix so the links work correctly in your browser.
                        // This depends on how your main web server serves static files.
                        // Example assumptions:
                        // - Your main HTML is served from the project root.
                        // - Your PDFs are in a folder named 'Documents' at the project root.
                        // - Your Flask RAG server (if it serves static files) also makes them accessible.
                        // You might need to adjust this path.
                        const fullPath = `Documents/${pdfFileName}`; // <--- ADJUST THIS PATH AS NEEDED
                        pdfLinksHtml += `<li><a href="${fullPath}" target="_blank">${pdfFileName}</a></li>`;
                    });
                    pdfLinksHtml += "</ul>";
                    // Add the PDF links as an HTML message
                    addChatMessage(pdfLinksHtml, 'bot', pageId, null, true); // true indicates HTML content
                }
                // --- END HANDLE API RESPONSE ---

            })
            .catch(error => {
                // Ensure the "thinking" message is removed if an error occurs before the response
                const tempMsgElement = document.getElementById(thinkingMessageId);
                if (tempMsgElement) {
                    tempMsgElement.remove();
                }

                console.error('Error in sendQueryToRAG:', error);

                // Display a user-friendly error message
                let userFriendlyMessage = "Sorry, I'm having trouble connecting to my knowledge base right now. Please ensure the RAG server is running and try again later.";
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    userFriendlyMessage = "Unable to connect to the AI assistant service. Please ensure the RAG server (server.py) is running.";
                } else if (error.message) {
                    userFriendlyMessage = `Error: ${error.message}`;
                }
                addChatMessage(userFriendlyMessage, 'bot', pageId);
            });
            // --- END SEND REQUEST ---
        }

        function addChatMessage(message, sender, pageId, elementId = null, isHtml = false) {
            const messagesContainer = document.getElementById(`chat-messages-${pageId}`);
            if (!messagesContainer) {
                console.error(`Chat messages container not found for pageId: ${pageId}`);
                return;
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${sender}-message`;
            if (elementId) {
                messageDiv.id = elementId;
            }

            if (isHtml) {
                messageDiv.innerHTML = message; // Use innerHTML for HTML content
            } else {
                messageDiv.textContent = message; // Use textContent for plain text
            }

            messagesContainer.appendChild(messageDiv);
            // Auto-scroll to the bottom of the chat
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        function addTemporaryMessage(message, sender, pageId, elementId) {
            addChatMessage(message, sender, pageId, elementId);
        }

        /**
         * Removes a temporary message element by its ID.
         * @param {string} elementId - The ID of the element to remove.
         */
        function removeTemporaryMessage(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                element.remove();
            }
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Add Enter key listeners for all chat inputs
            document.querySelectorAll('[id^="chat-input"]').forEach(input => {
                input.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        const pageId = this.id.replace('chat-input-', '');
                        sendMessage(pageId);
                    }
                });
            });
            
            init();

        });
                // Updated fuel data structure
        const fuelDataIMO = {
            "HFO": [0.0402, 92.78408, 3.114, 475],
            "LFO": [0.0412, 90.87233, 3.151, 500],
            "MDO/MGO": [0.0427, 93.9319, 3.206, 720],
            "VLSFO": [0.0402, 95.48408, 3.114, 520],
            "ULSFO": [0.0402, 95.48408, 3.114, 520],
            "BioFuel B24-HFO": [0.0397, 77, 2.367, 0],
            "BioFuel B24-LFO": [0.0400, 77, 2.395, 0],
            "BioFuel B24-VLSFO": [0.0400, 77, 2.395, 0],
            "LNG Otto - Medium Speed": [0.04910, 89.20293, 2.75000, 754],
            "LNG Otto - Slow Speed": [0.04910, 82.86808, 2.75000, 754],
            "LNG Diesel - Slow Speed": [0.04910, 76.08074, 2.75000, 754],
            "LNG - LBSI": [0.04910, 86.94048, 2.75000, 754],
            "LPG": [0.04600, 74.21065, 3.00000, 0],
            "H2": [0.12000, 132.39750, 0, 0],
            "NH3": [0.01860, 121.00000, 0, 0],
            "Methanol": [0.01950, 101.81282, 1.37500, 0],
            "Ethanol": [0.02700, 37.27037, 1.91300, 0],
            "Bio-diesel": [0.03700, 27.29459, 2.83400, 1200],
            "HVO": [0.04400, 34.51136, 3.11500, 0],
            "Bio-LNG Otto - Medium": [0.05000, 30.00000, 2.75000, 1871],
            "Bio-LNG Otto - Slow": [0.05000, 30.00000, 2.75000, 1871],
            "Bio-LNG Diesel - Slow": [0.05000, 30.58300, 2.75000, 1871],
            "Bio-LNG - LBSI": [0.05000, 30.00000, 2.75000, 1871],
            "Bio-methanol": [0.02000, 13.35000, 1.37500, 0],
            "Other-H2": [0.12000, 24.90000, 3.11500, 0],
            "e-H2": [0.12000, 30.39750, 0, 0],
            "e-diesel": [0.03700, 115.27568, 3.20600, 0],
            "e-methanol": [0.01990, 84.89246, 1.37500, 0],
            "e-LNG Otto - Medium": [0.04910, 86.00815, 2.75000, 0],
            "e-LNG Otto - Slow": [0.04910, 86.00815, 2.75000, 0],
            "e-LNG Diesel - Slow": [0.04910, 86.60183, 2.75000, 0],
            "e-LNG - LBSI": [0.04910, 86.00815, 2.75000, 0],
            "e-NH3": [0.01860, 30.00000, 0, 0],
            "e-LPG": [0.04600, 96.28478, 3.00000, 0],
            "e-DME": [0.02800, 99.96786, 1.91000, 0],
            "BioFuel B30-HFO": [0.03894, 72.5245, 3.030, 79]
        };

        // GFI targets
        const gfiTargets = {
            2028: { 'base': 89.568, 'direct': 77.439 },
            2029: { 'base': 87.702, 'direct': 75.573 },
            2030: { 'base': 85.836, 'direct': 73.707 },
            2031: { 'base': 81.7308, 'direct': 69.6018 },
            2032: { 'base': 77.6256, 'direct': 65.4966 },
            2033: { 'base': 73.5204, 'direct': 61.3914 },
            2034: { 'base': 69.412, 'direct': 57.2862 },
            2035: { 'base': 65.31, 'direct': 53.181 },
            2036: { 'base': 58.779, 'direct': 49.449 },
            2037: { 'base': 52.248, 'direct': 44.784 },
            2038: { 'base': 45.717, 'direct': 41.052 },
            2039: { 'base': 39.186, 'direct': 36.7602 },
            2040: { 'base': 32.655, 'direct': 32.655 },
            2041: { 'base': 27.756, 'direct': 27.756 },
            2042: { 'base': 23.593, 'direct': 23.593 },
            2043: { 'base': 19.9, 'direct': 19.9 },
            2044: { 'base': 16.5, 'direct': 16.5 },
            2045: { 'base': 13.2, 'direct': 13.2 },
            2046: { 'base': 10.5, 'direct': 10.5 },
            2047: { 'base': 8, 'direct': 8 },
            2048: { 'base': 5.5, 'direct': 5.5 },
            2049: { 'base': 2.5, 'direct': 2.5 },
            2050: { 'base': 0, 'direct': 0 }
        };

        // Add remaining years
        for (let year = 2051; year <= 2060; year++) {
            gfiTargets[year] = { 'base': 0, 'direct': 0 };
        }

        // Global variables
        let baselineFuelCount = 0;
        let alternativeScenarioCount = 0;
        let calculationResults = {};
        let capexInputs = [];

        // Populate year selectors
        function populateYearSelectors() {
            const startYear = parseInt(document.getElementById('startYear').value) || 2028;
            const vesselLifespan = parseInt(document.getElementById('vesselLifespan').value) || 25;

            const yearSelectors = ['capexYear', 'sensitivityYear'];
            yearSelectors.forEach(selectorId => {
                const selector = document.getElementById(selectorId);
                if (selector) {
                    selector.innerHTML = '';
                    for (let i = 0; i < vesselLifespan; i++) {
                        const year = startYear + i;
                        selector.innerHTML += `<option value="${year}">${year}</option>`;
                    }
                }
            });
        }

        // Create fuel selector options
        function createFuelOptions(selectedValue = '') {
            let options = '<option value="">Select Fuel</option>';
            Object.keys(fuelDataIMO).forEach(fuel => {
                const selected = fuel === selectedValue ? 'selected' : '';
                options += `<option value="${fuel}" ${selected}>${fuel}</option>`;
            });
            return options;
        }

        // Check if fuel is LNG type
        function isLNGFuel(fuelName) {
            return fuelName && fuelName.toLowerCase().includes('lng');
        }

        // Add baseline fuel
        function addBaselineFuel() {
            baselineFuelCount++;
            const container = document.getElementById('baselineFuelsContainer');

            const fuelDiv = document.createElement('div');
            fuelDiv.className = 'fuel-grid';
            fuelDiv.id = `baselineFuel${baselineFuelCount}`;

            fuelDiv.innerHTML = `
                <div class="input-group">
                    <label>Fuel Type</label>
                    <select id="baselineFuelType${baselineFuelCount}" onchange="updateFuelCost('baseline', ${baselineFuelCount})">
                        ${createFuelOptions()}
                    </select>
                </div>
                <div class="input-group">
                    <label>Volume (MT)</label>
                    <input type="number" id="baselineFuelVolume${baselineFuelCount}" value="0" min="0" step="0.01">
                </div>
                <div class="input-group">
                    <label>Cost per MT (USD)</label>
                    <input type="number" id="baselineFuelCost${baselineFuelCount}" value="0" min="0" step="0.01">
                </div>
                ${baselineFuelCount > 1 ? `<button class="btn btn-danger btn-small" onclick="removeBaselineFuel(${baselineFuelCount})">Remove</button>` : ''}
            `;

            container.appendChild(fuelDiv);
        }

        // Remove baseline fuel
        function removeBaselineFuel(fuelIndex) {
            const fuelDiv = document.getElementById(`baselineFuel${fuelIndex}`);
            if (fuelDiv) {
                fuelDiv.remove();
            }
        }

        // Update fuel cost when fuel type changes
        function updateFuelCost(scenarioType, index) {
            const fuelType = document.getElementById(`${scenarioType}FuelType${index}`).value;
            const costInput = document.getElementById(`${scenarioType}FuelCost${index}`);

            if (fuelType && fuelDataIMO[fuelType] && costInput) {
                costInput.value = fuelDataIMO[fuelType][3]; // Default cost
            }
        }

        // Add alternative scenario
        function addAlternativeScenario() {
            alternativeScenarioCount++;
            const container = document.getElementById('alternativeScenariosContainer');

            const scenarioDiv = document.createElement('div');
            scenarioDiv.className = 'scenario-item';
            scenarioDiv.id = `altScenario${alternativeScenarioCount}`;

            scenarioDiv.innerHTML = `
                <div class="scenario-header">
                    <div class="scenario-title">Alternative Scenario ${alternativeScenarioCount}</div>
                    ${alternativeScenarioCount > 1 ? `<button class="btn btn-danger btn-small" onclick="removeAlternativeScenario(${alternativeScenarioCount})">Remove</button>` : ''}
                </div>

                <div class="scenario-type">
                    <label><input type="radio" name="scenarioType${alternativeScenarioCount}" value="full" checked onchange="updateScenarioType(${alternativeScenarioCount})"> Full Alternate</label>
                    <label><input type="radio" name="scenarioType${alternativeScenarioCount}" value="reachBase" onchange="updateScenarioType(${alternativeScenarioCount})"> Reach Base Target</label>
                    <label><input type="radio" name="scenarioType${alternativeScenarioCount}" value="reachDirect" onchange="updateScenarioType(${alternativeScenarioCount})"> Reach Direct Target</label>
                </div>

                <div id="scenarioContent${alternativeScenarioCount}">
                    <!-- Content will be populated by updateScenarioType -->
                </div>

                <div class="input-grid" style="margin-top: 20px;">
                    <div class="input-group">
                        <label>ESD Savings (%)</label>
                        <input type="number" id="altESD${alternativeScenarioCount}" value="0" min="0" max="100" step="0.1">
                    </div>
                    <div class="input-group">
                        <label>ESD CAPEX (USD)</label>
                        <input type="number" id="altESDCapex${alternativeScenarioCount}" value="0" min="0" step="1">
                    </div>
                    <div class="input-group">
                        <label>Additional CAPEX (USD)</label>
                        <input type="number" id="altCapex${alternativeScenarioCount}" value="0" min="0" step="1">
                    </div>
                    <div class="input-group">
                        <label>CAPEX Description</label>
                        <input type="text" id="altCapexDescription${alternativeScenarioCount}" placeholder="e.g., Scrubber, BWTS">
                    </div>
                </div>
            `;

            container.appendChild(scenarioDiv);
            updateScenarioType(alternativeScenarioCount);
        }

        // Remove alternative scenario
        function removeAlternativeScenario(scenarioIndex) {
            const scenarioDiv = document.getElementById(`altScenario${scenarioIndex}`);
            if (scenarioDiv) {
                scenarioDiv.remove();
            }
        }

        // Remove last alternative scenario
        function removeLastAlternativeScenario() {
            if (alternativeScenarioCount > 1) {
                removeAlternativeScenario(alternativeScenarioCount);
                alternativeScenarioCount--;
            }
        }

        // Update scenario type content
        function updateScenarioType(scenarioIndex) {
            const scenarioTypeElement = document.querySelector(`input[name="scenarioType${scenarioIndex}"]:checked`);
            if (!scenarioTypeElement) return;

            const scenarioType = scenarioTypeElement.value;
            const contentDiv = document.getElementById(`scenarioContent${scenarioIndex}`);

            let content = '';

            if (scenarioType === 'full') {
                content = `
                    <div id="altFuelsContainer${scenarioIndex}">
                        <div class="fuel-grid" id="altFuel${scenarioIndex}_1">
                            <div class="input-group">
                                <label>Fuel Type</label>
                                <select id="altFuelType${scenarioIndex}_1" onchange="updateAltFuelCost(${scenarioIndex}, 1); checkLNGFuel(${scenarioIndex}); updateFuelPercentages(${scenarioIndex}, 1)">
                                    ${createFuelOptions()}
                                </select>
                            </div>
                            <div class="input-group">
                                <label>Percentage (%)</label>
                                <input type="number" id="altFuelPercentage${scenarioIndex}_1" value="100" min="0" max="100" step="0.1" onchange="updateFuelPercentages(${scenarioIndex}, 1)">
                            </div>
                            <div class="input-group">
                                <label>Cost per MT (USD)</label>
                                <input type="number" id="altFuelCost${scenarioIndex}_1" value="0" min="0" step="0.01">
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-success btn-small" onclick="addAlternativeFuel(${scenarioIndex})">+ Add Fuel</button>
                    <div id="pilotFuelSection${scenarioIndex}" class="pilot-fuel-section hidden">
                        <h5>Pilot Fuel Configuration</h5>
                        <div class="input-grid">
                            <div class="input-group">
                                <label>Pilot Fuel Type</label>
                                <select id="pilotFuelType${scenarioIndex}">
                                    ${createFuelOptions('MDO/MGO')}
                                </select>
                            </div>
                            <div class="input-group">
                                <label>Pilot Fuel Percentage (%)</label>
                                <input type="number" id="pilotFuelPercentage${scenarioIndex}" value="5" min="0" max="100" step="0.1">
                            </div>
                            <div class="input-group">
                                <label>Pilot Fuel Cost per MT (USD)</label>
                                <input type="number" id="pilotFuelCost${scenarioIndex}" value="720" min="0" step="0.01">
                            </div>
                        </div>
                    </div>
                `;
            } else {
                content = `
                    <div class="input-grid">
                        <div class="input-group">
                            <label>Primary Fuel</label>
                            <select id="primaryFuel${scenarioIndex}" onchange="checkLNGFuelTarget(${scenarioIndex})">
                                ${createFuelOptions()}
                            </select>
                        </div>
                        <div class="input-group" id="secondaryFuelGroup${scenarioIndex}">
                            <label>Secondary Fuel</label>
                            <select id="secondaryFuel${scenarioIndex}">
                                ${createFuelOptions()}
                            </select>
                        </div>
                        <div class="input-group">
                            <label>Replacement Fuel</label>
                            <select id="replacementFuel${scenarioIndex}" onchange="checkLNGFuelTarget(${scenarioIndex})">
                                ${createFuelOptions()}
                            </select>
                        </div>
                    </div>
                    <div id="pilotFuelSectionTarget${scenarioIndex}" class="pilot-fuel-section hidden">
                        <h5>Pilot Fuel Configuration</h5>
                        <div class="input-grid">
                            <div class="input-group">
                                <label>Pilot Fuel Type</label>
                                <select id="pilotFuelTypeTarget${scenarioIndex}">
                                    ${createFuelOptions('MDO/MGO')}
                                </select>
                            </div>
                            <div class="input-group">
                                <label>Pilot Fuel Percentage (%)</label>
                                <input type="number" id="pilotFuelPercentageTarget${scenarioIndex}" value="5" min="0" max="100" step="0.1">
                            </div>
                            <div class="input-group">
                                <label>Pilot Fuel Cost per MT (USD)</label>
                                <input type="number" id="pilotFuelCostTarget${scenarioIndex}" value="720" min="0" step="0.01">
                            </div>
                        </div>
                    </div>
                `;
            }

            contentDiv.innerHTML = content;

            // Initialize fuel cost for the first fuel in full alternate
            if (scenarioType === 'full') {
                setTimeout(() => updateAltFuelCost(scenarioIndex, 1), 100);
            }
        }

        // Update alternative fuel cost
        function updateAltFuelCost(scenarioIndex, fuelIndex) {
            const fuelType = document.getElementById(`altFuelType${scenarioIndex}_${fuelIndex}`).value;
            const costInput = document.getElementById(`altFuelCost${scenarioIndex}_${fuelIndex}`);

            if (fuelType && fuelDataIMO[fuelType] && costInput) {
                costInput.value = fuelDataIMO[fuelType][3];
            }
        }

        // Check if LNG fuel is selected and show pilot fuel section
        function checkLNGFuel(scenarioIndex) {
            const container = document.getElementById(`altFuelsContainer${scenarioIndex}`);
            if (!container) return;

            const fuelSelects = container.querySelectorAll('select[id^="altFuelType"]');
            let hasLNG = false;

            fuelSelects.forEach(select => {
                if (isLNGFuel(select.value)) {
                    hasLNG = true;
                }
            });

            const pilotSection = document.getElementById(`pilotFuelSection${scenarioIndex}`);
            if (pilotSection) {
                if (hasLNG) {
                    pilotSection.classList.remove('hidden');
                } else {
                    pilotSection.classList.add('hidden');
                }
            }
        }

        // Check LNG fuel for target scenarios - UPDATED LOGIC
        function checkLNGFuelTarget(scenarioIndex) {
            const primaryFuelElement = document.getElementById(`primaryFuel${scenarioIndex}`);
            const replacementFuelElement = document.getElementById(`replacementFuel${scenarioIndex}`);
            const secondaryFuelGroup = document.getElementById(`secondaryFuelGroup${scenarioIndex}`);
            const pilotSection = document.getElementById(`pilotFuelSectionTarget${scenarioIndex}`);

            if (!primaryFuelElement || !pilotSection || !secondaryFuelGroup) return;

            const primaryFuel = primaryFuelElement.value;
            const replacementFuel = replacementFuelElement ? replacementFuelElement.value : '';

            const primaryIsLNG = isLNGFuel(primaryFuel);
            const replacementIsLNG = isLNGFuel(replacementFuel);

            // Show pilot fuel section if EITHER primary OR replacement fuel is LNG
            if (primaryIsLNG || replacementIsLNG) {
                pilotSection.classList.remove('hidden');
                // If replacement fuel is LNG, hide secondary fuel
                if (replacementIsLNG) {
                    secondaryFuelGroup.classList.add('hidden');
                } else {
                    secondaryFuelGroup.classList.remove('hidden');
                }
            } else {
                // Neither is LNG, hide pilot fuel and show secondary fuel
                pilotSection.classList.add('hidden');
                secondaryFuelGroup.classList.remove('hidden');
            }
        }



        // Add alternative fuel to full alternate scenario
        function addAlternativeFuel(scenarioIndex) {
            const container = document.getElementById(`altFuelsContainer${scenarioIndex}`);
            if (!container) return;

            const fuelCount = container.querySelectorAll(".fuel-grid").length + 1;

            const fuelDiv = document.createElement("div");
            fuelDiv.className = "fuel-grid";
            fuelDiv.id = `altFuel${scenarioIndex}_${fuelCount}`;

            fuelDiv.innerHTML = `
                <div class="input-group">
                    <label>Fuel Type</label>
                    <select id="altFuelType${scenarioIndex}_${fuelCount}" onchange="updateAltFuelCost(${scenarioIndex}, ${fuelCount}); checkLNGFuel(${scenarioIndex}); updateFuelPercentages(${scenarioIndex}, ${fuelCount})">
                        ${createFuelOptions()}
                    </select>
                </div>
                <div class="input-group">
                    <label>Percentage (%)</label>
                    <input type="number" id="altFuelPercentage${scenarioIndex}_${fuelCount}" value="0" min="0" max="100" step="0.1" onchange="updateFuelPercentages(${scenarioIndex}, ${fuelCount})">
                </div>
                <div class="input-group">
                    <label>Cost per MT (USD)</label>
                    <input type="number" id="altFuelCost${scenarioIndex}_${fuelCount}" value="0" min="0" step="0.01">
                </div>
                <button class="btn btn-danger btn-small" onclick="removeAlternativeFuel(${scenarioIndex}, ${fuelCount})">Remove</button>
            `;

            container.appendChild(fuelDiv);
            updateFuelPercentages(scenarioIndex, fuelCount); // Call to re-distribute percentages
        }

        // Remove alternative fuel
        function removeAlternativeFuel(scenarioIndex, fuelIndex) {
            const fuelDiv = document.getElementById(`altFuel${scenarioIndex}_${fuelIndex}`);
            if (fuelDiv) {
                fuelDiv.remove();
                checkLNGFuel(scenarioIndex);
                // Re-distribute percentages after removal
                updateFuelPercentages(scenarioIndex, -1); // -1 indicates removal, trigger redistribution
            }
        }

        // Update fuel percentages for full alternate scenario
        function updateFuelPercentages(scenarioIndex, changedFuelIndex) {
            const container = document.getElementById(`altFuelsContainer${scenarioIndex}`);
            if (!container) return;

            const fuelPercentageInputs = Array.from(container.querySelectorAll(`input[id^="altFuelPercentage${scenarioIndex}"]`));
            let totalPercentage = 0;

            fuelPercentageInputs.forEach(input => {
                totalPercentage += parseFloat(input.value) || 0;
            });

            if (totalPercentage < 100) {
                // If the total is less than 100, add a new fuel
                addAlternativeFuel(scenarioIndex);
                const newFuelPercentageInputs = Array.from(container.querySelectorAll(`input[id^="altFuelPercentage${scenarioIndex}"]`));
                const lastFuelInput = newFuelPercentageInputs[newFuelPercentageInputs.length - 1];
                if (lastFuelInput) {
                    lastFuelInput.value = (100 - totalPercentage).toFixed(1);
                }
            } else if (totalPercentage > 100) {
                // If total exceeds 100, adjust the last changed fuel
                const changedInput = document.getElementById(`altFuelPercentage${scenarioIndex}_${changedFuelIndex}`);
                if (changedInput) {
                    const currentValue = parseFloat(changedInput.value) || 0;
                    const excess = totalPercentage - 100;
                    changedInput.value = (currentValue - excess).toFixed(1);
                }
            }
        }

        // Tab functionality
        function showTab(tabName, event) {
            // Hide all tab contents
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => content.classList.remove('active'));

            // Remove active class from all tabs
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => tab.classList.remove('active'));

            // Show selected tab content
            document.getElementById(tabName).classList.add('active');

            // Add active class to clicked tab
            if (event && event.target) {
                event.target.classList.add('active');
            } else {
                // If no event (programmatic call), find the tab button by onclick attribute
                const tabButtons = document.querySelectorAll('.tab');
                tabButtons.forEach(tab => {
                    if (tab.getAttribute('onclick') && tab.getAttribute('onclick').includes(`'${tabName}'`)) {
                        tab.classList.add('active');
                    }
                });
            }
        }

        // Cumulative Savings Chart variable
        let cumulativeSavingsChart = null;

        // Create cumulative savings area graphs
        function createCumulativeSavingsChart() {
            if (!calculationResults.baseline) return;

            const ctx = document.getElementById('cumulativeSavingsChart').getContext('2d');

            // Get selected scenarios
            const scenario1Element = document.getElementById('cumulativeScenario1');
            const scenario2Element = document.getElementById('cumulativeScenario2');

            const scenario1 = scenario1Element ? scenario1Element.value : 'baseline';
            const scenario2 = scenario2Element ? scenario2Element.value : 'bestCase';

            // Destroy existing chart
            if (cumulativeSavingsChart) {
                cumulativeSavingsChart.destroy();
            }

            const years = Object.keys(calculationResults.baseline).map(year => parseInt(year)).sort((a, b) => a - b);
            const startYear = years[0];
            const discountRate = parseFloat(document.getElementById('discountRate').value) || 7;

            // Calculate cumulative savings between the two selected scenarios
            let cumulativeSavings = [];
            let cumulativeSavingsDiscounted = [];
            let runningTotal = 0;
            let runningDiscountedTotal = 0;

            years.forEach((year, index) => {
                const scenario1Cost = getScenarioData(scenario1, year).totalCost || 0;
                const scenario2Cost = getScenarioData(scenario2, year).totalCost || 0;
                const yearSavings = scenario1Cost - scenario2Cost;
                const yearSavingsDiscounted = calculateDiscountedValue(yearSavings, year, startYear, discountRate);

                runningTotal += yearSavings;
                runningDiscountedTotal += yearSavingsDiscounted;

                cumulativeSavings.push(runningTotal);
                cumulativeSavingsDiscounted.push(runningDiscountedTotal);
            });

            // Get CAPEX data for scenario 2
            const scenario2Data = getScenarioDataForCapex(scenario2);
            const esdCapex = scenario2Data.esdCapex || 0;
            const additionalCapex = scenario2Data.additionalCapex || 0;
            const totalCapex = esdCapex + additionalCapex;

            // Create datasets
            const datasets = [
                {
                    label: 'Cumulative Savings',
                    data: cumulativeSavings,
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    fill: true,
                    tension: 0.4,
                    pointRadius: 4,
                    pointBackgroundColor: 'rgb(75, 192, 192)'
                },
                {
                    label: 'Cumulative Savings (Discounted)',
                    data: cumulativeSavingsDiscounted,
                    borderColor: 'rgb(54, 162, 235)',
                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                    fill: true,
                    tension: 0.4,
                    pointRadius: 4,
                    pointBackgroundColor: 'rgb(54, 162, 235)'
                }
            ];

            // Add CAPEX lines if they exist
            if (esdCapex > 0) {
                datasets.push({
                    label: 'ESD CAPEX',
                    data: years.map(() => esdCapex),
                    borderColor: 'rgb(255, 99, 132)',
                    backgroundColor: 'rgba(255, 99, 132, 0)',
                    borderWidth: 2,
                    borderDash: [5, 5],
                    pointRadius: 0,
                    fill: false,
                    type: 'line'
                });
            }

            if (additionalCapex > 0) {
                datasets.push({
                    label: 'Additional CAPEX',
                    data: years.map(() => additionalCapex),
                    borderColor: 'rgb(255, 159, 64)',
                    backgroundColor: 'rgba(255, 159, 64, 0)',
                    borderWidth: 2,
                    borderDash: [10, 5],
                    pointRadius: 0,
                    fill: false,
                    type: 'line'
                });
            }

            if (totalCapex > 0) {
                datasets.push({
                    label: 'Total CAPEX',
                    data: years.map(() => totalCapex),
                    borderColor: 'rgb(153, 102, 255)',
                    backgroundColor: 'rgba(153, 102, 255, 0)',
                    borderWidth: 3,
                    borderDash: [15, 5],
                    pointRadius: 0,
                    fill: false,
                    type: 'line'
                });
            }

            cumulativeSavingsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: years,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `Cumulative Savings Analysis: ${scenario1} vs ${scenario2}`
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Cumulative Savings (USD)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return '$' + (value / 1000000).toFixed(1) + 'M';
                                }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Year'
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });
        }

        // Get scenario data for CAPEX
        function getScenarioDataForCapex(scenarioKey) {
            if (scenarioKey === 'baseline') {
                return {
                    esdCapex: parseFloat(document.getElementById('baselineESDCapex').value) || 0,
                    additionalCapex: parseFloat(document.getElementById('baselineCapex').value) || 0
                };
            } else if (scenarioKey.startsWith('alt_')) {
                const altId = parseInt(scenarioKey.split('_')[1]);
                return {
                    esdCapex: parseFloat(document.getElementById(`altESDCapex${altId}`).value) || 0,
                    additionalCapex: parseFloat(document.getElementById(`altCapex${altId}`).value) || 0
                };
            }
            return { esdCapex: 0, additionalCapex: 0 };
        }

        function calculateTotalEnergy(fuels) {
            let totalEnergy = 0;
            fuels.forEach(fuel => {
                if (fuel.type && fuelDataIMO[fuel.type] && typeof fuel.volume === 'number' && fuel.volume > 0) {
                    const lcv = fuelDataIMO[fuel.type][0];
                    totalEnergy += fuel.volume * lcv * 1000000; // Convert to MJ
                }
            });
            return totalEnergy;
        }

        // Calculate GFI intensity
        function calculateGFIIntensity(fuels, totalEnergy) {
            if (totalEnergy === 0) return 0;

            let weightedGHG = 0;
            fuels.forEach(fuel => {
                if (fuel.type && fuelDataIMO[fuel.type] && typeof fuel.volume === 'number' && fuel.volume > 0) {
                    const lcv = fuelDataIMO[fuel.type][0];
                    const ghg = fuelDataIMO[fuel.type][1];
                    const fuelEnergy = fuel.volume * lcv * 1000000;
                    weightedGHG += fuelEnergy * ghg;
                }
            });

            return weightedGHG / totalEnergy;
        }

        // Calculate bunker cost
        function calculateBunkerCost(fuels) {
            let totalCost = 0;
            fuels.forEach(fuel => {
                if (typeof fuel.volume === 'number' && fuel.volume > 0 && typeof fuel.cost === 'number' && fuel.cost > 0) {
                    totalCost += fuel.volume * fuel.cost;
                }
            });
            return totalCost;
        }

        // Calculate discounted value
        function calculateDiscountedValue(value, year, startYear, discountRate) {
            const n = year - startYear;
            return value / Math.pow(1 + discountRate / 100, n);
        }

        // Calculate penalties and surplus
        function calculatePenaltiesAndSurplus(gfiIntensity, totalEnergy, year, poolingPrice) {
            if (!gfiTargets[year]) {
                return { tier1Penalty: 0, tier2Penalty: 0, surplus: 0 };
            }

            const directTarget = gfiTargets[year].direct;
            const baseTarget = gfiTargets[year].base;

            let tier1Penalty = 0;
            let tier2Penalty = 0;
            let surplus = 0;

            if (gfiIntensity <= directTarget) {
                // Surplus case
                surplus = (directTarget - gfiIntensity) * totalEnergy * poolingPrice / 1000000;
            } else if (gfiIntensity <= baseTarget) {
                // Tier 1 penalty only
                tier1Penalty = (gfiIntensity - directTarget) * totalEnergy * 100 / 1000000;
            } else {
                // Both tier 1 and tier 2 penalties
                tier1Penalty = (baseTarget - directTarget) * totalEnergy * 100 / 1000000;
                tier2Penalty = (gfiIntensity - baseTarget) * totalEnergy * 380 / 1000000;
            }

            return { tier1Penalty, tier2Penalty, surplus };
        }

        // Get baseline fuels
        function getBaselineFuels() {
            const fuels = [];
            for (let i = 1; i <= baselineFuelCount; i++) {
                const fuelDiv = document.getElementById(`baselineFuel${i}`);
                if (fuelDiv) {
                    const typeElement = document.getElementById(`baselineFuelType${i}`);
                    const volumeElement = document.getElementById(`baselineFuelVolume${i}`);
                    const costElement = document.getElementById(`baselineFuelCost${i}`);

                    if (typeElement && volumeElement && costElement) {
                        const type = typeElement.value;
                        const volume = parseFloat(volumeElement.value) || 0;
                        const cost = parseFloat(costElement.value) || 0;

                        if (type && volume > 0) {
                            fuels.push({ type, volume, cost });
                        }
                    }
                }
            }
            return fuels;
        }

        // Get alternative scenario data - UPDATED FOR REPLACEMENT FUEL AND VOLUME PARSING
        function getAlternativeScenarios() {
            const scenarios = [];

            for (let i = 1; i <= alternativeScenarioCount; i++) {
                const scenarioDiv = document.getElementById(`altScenario${i}`);
                if (!scenarioDiv) continue;

                try {
                    const scenarioTypeElement = document.querySelector(`input[name="scenarioType${i}"]:checked`);
                    if (!scenarioTypeElement) continue;

                    const scenarioType = scenarioTypeElement.value;
                    const esdSavingsElement = document.getElementById(`altESD${i}`);
                    const esdCapexElement = document.getElementById(`altESDCapex${i}`);
                    const additionalCapexElement = document.getElementById(`altCapex${i}`);
                    const capexDescriptionElement = document.getElementById(`altCapexDescription${i}`);

                    const esdSavings = esdSavingsElement ? parseFloat(esdSavingsElement.value) || 0 : 0;
                    const esdCapex = esdCapexElement ? parseFloat(esdCapexElement.value) || 0 : 0;
                    const additionalCapex = additionalCapexElement ? parseFloat(additionalCapexElement.value) || 0 : 0;
                    const capexDescription = capexDescriptionElement ? capexDescriptionElement.value : "";

                    const scenario = {
                        id: i,
                        type: scenarioType,
                        esdSavings,
                        esdCapex,
                        additionalCapex,
                        capexDescription,
                        name: `Alt Scenario ${i} (${scenarioType === 'full' ? 'Full Alternate' : scenarioType === 'reachBase' ? 'Reach Base Target' : 'Reach Direct Target'})`
                    };

                    if (scenarioType === 'full') {
                        // Get all fuels for full alternate
                        scenario.fuels = [];
                        const container = document.getElementById(`altFuelsContainer${i}`);
                        if (container) {
                            const fuelGrids = container.querySelectorAll(".fuel-grid");

                            fuelGrids.forEach((grid, index) => {
                                const fuelIndex = index + 1;
                                const typeElement = document.getElementById(`altFuelType${i}_${fuelIndex}`);
                                const percentageElement = document.getElementById(`altFuelPercentage${i}_${fuelIndex}`);
                                const costElement = document.getElementById(`altFuelCost${i}_${fuelIndex}`);

                                if (typeElement && percentageElement && costElement) {
                                    const type = typeElement.value;
                                    const percentage = parseFloat(percentageElement.value) || 0;
                                    const cost = parseFloat(costElement.value) || 0;

                                    // Add volume property, initially 0, will be calculated later if needed
                                    scenario.fuels.push({ type, percentage, cost, volume: 0 });
                                }
                            });
                        }

                        // Check for pilot fuel
                        const pilotSection = document.getElementById(`pilotFuelSection${i}`);
                        if (pilotSection && !pilotSection.classList.contains('hidden')) {
                            const pilotTypeElement = document.getElementById(`pilotFuelType${i}`);
                            const pilotPercentageElement = document.getElementById(`pilotFuelPercentage${i}`);
                            const pilotCostElement = document.getElementById(`pilotFuelCost${i}`);

                            if (pilotTypeElement && pilotPercentageElement && pilotCostElement) {
                                scenario.pilotFuel = {
                                    type: pilotTypeElement.value,
                                    percentage: parseFloat(pilotPercentageElement.value) || 5,
                                    cost: parseFloat(pilotCostElement.value) || 0
                                };
                            }
                        }
                    } else {
                        // Reach base/direct target scenarios - UPDATED FOR REPLACEMENT FUEL
                        const primaryFuelElement = document.getElementById(`primaryFuel${i}`);
                        const secondaryFuelElement = document.getElementById(`secondaryFuel${i}`);
                        const replacementFuelElement = document.getElementById(`replacementFuel${i}`);

                        if (primaryFuelElement && replacementFuelElement) {
                            scenario.primaryFuel = primaryFuelElement.value;
                            scenario.replacementFuel = replacementFuelElement.value;
                            scenario.targetType = scenarioType === 'reachBase' ? 'base' : 'direct';

                            // Only include secondary fuel if it's visible (not hidden due to LNG replacement fuel)
                            const secondaryFuelGroup = document.getElementById(`secondaryFuelGroup${i}`);
                            if (secondaryFuelElement && secondaryFuelGroup && !secondaryFuelGroup.classList.contains('hidden')) {
                                scenario.secondaryFuel = secondaryFuelElement.value;
                            }

                            // Check for pilot fuel
                            const pilotSection = document.getElementById(`pilotFuelSectionTarget${i}`);
                            if (pilotSection && !pilotSection.classList.contains('hidden')) {
                                const pilotTypeElement = document.getElementById(`pilotFuelTypeTarget${i}`);
                                const pilotPercentageElement = document.getElementById(`pilotFuelPercentageTarget${i}`);
                                const pilotCostElement = document.getElementById(`pilotFuelCostTarget${i}`);

                                if (pilotTypeElement && pilotPercentageElement && pilotCostElement) {
                                    scenario.pilotFuel = {
                                        type: pilotTypeElement.value,
                                        percentage: parseFloat(pilotPercentageElement.value) || 5,
                                        cost: parseFloat(pilotCostElement.value) || 0
                                    };
                                }
                            }
                        }
                    }

                    scenarios.push(scenario);
                } catch (error) {
                    console.error(`Error processing scenario ${i}:`, error);
                }
            }

            return scenarios;
        }

        // Calculate scenario for a specific year
        function calculateScenarioForYear(scenario, year, baselineTotalEnergy) {
            const startYear = parseInt(document.getElementById('startYear').value) || 2028;
            const discountRate = parseFloat(document.getElementById('discountRate').value) || 7;
            const poolingPrice = parseFloat(document.getElementById('poolingRevenue').value) || 50;

            let fuels = [];
            let totalEnergy = 0;
            let bunkerCost = 0;
            let gfiIntensity = 0;

            try {
                if (scenario.type === 'full') {
                    const totalVolume = scenario.fuels.reduce((sum, fuel) => sum + fuel.volume, 0);
                    if (totalVolume <= 0) {
                        // If no volumes are provided, use percentages to derive volumes from baseline energy
                        const totalEnergyForScenario = baselineTotalEnergy * (1 - scenario.esdSavings / 100);
                        scenario.fuels.forEach(fuel => {
                            if (fuel.type && fuelDataIMO[fuel.type] && fuel.percentage > 0) {
                                const lcv = fuelDataIMO[fuel.type][0];
                                const energyForThisFuel = totalEnergyForScenario * (fuel.percentage / 100);
                                const volume = energyForThisFuel / (lcv * 1000000);
                                fuels.push({ type: fuel.type, volume: volume, cost: fuel.cost });
                            }
                        });
                    } else {
                        // If volumes are provided, use them directly
                        fuels = scenario.fuels.map(f => ({...f}));
                    }

                    if (scenario.pilotFuel) {
                        fuels = applyPilotFuelToMix(fuels, scenario.pilotFuel);
                    }

                    totalEnergy = calculateTotalEnergy(fuels);
                    bunkerCost = calculateBunkerCost(fuels);
                    gfiIntensity = calculateGFIIntensity(fuels, totalEnergy);

                } else {
                    // Reach target scenarios: optimize fuel mix
                    const target = gfiTargets[year] ? gfiTargets[year][scenario.targetType] : 0;
                    const totalEnergyAfterESD = baselineTotalEnergy * (1 - scenario.esdSavings / 100);
                    const optimizedFuels = optimizeFuelMixForTarget(scenario, target, totalEnergyAfterESD, year);

                    fuels = optimizedFuels;
                    totalEnergy = calculateTotalEnergy(fuels);
                    bunkerCost = calculateBunkerCost(fuels);
                    gfiIntensity = calculateGFIIntensity(fuels, totalEnergy);
                }

                const penalties = calculatePenaltiesAndSurplus(gfiIntensity, totalEnergy, year, poolingPrice);

                const bunkerCostDiscounted = calculateDiscountedValue(bunkerCost, year, startYear, discountRate);
                const tier1PenaltyDiscounted = calculateDiscountedValue(penalties.tier1Penalty, year, startYear, discountRate);
                const tier2PenaltyDiscounted = calculateDiscountedValue(penalties.tier2Penalty, year, startYear, discountRate);
                const surplusDiscounted = calculateDiscountedValue(penalties.surplus, year, startYear, discountRate);

                const totalCost = bunkerCost + penalties.tier1Penalty + penalties.tier2Penalty - penalties.surplus;
                const totalCostDiscounted = bunkerCostDiscounted + tier1PenaltyDiscounted + tier2PenaltyDiscounted - surplusDiscounted;

                return {
                    fuels,
                    totalEnergy,
                    gfiIntensity,
                    bunkerCost,
                    bunkerCostDiscounted,
                    tier1Penalty: penalties.tier1Penalty,
                    tier1PenaltyDiscounted,
                    tier2Penalty: penalties.tier2Penalty,
                    tier2PenaltyDiscounted,
                    surplus: penalties.surplus,
                    surplusDiscounted,
                    totalCost,
                    totalCostDiscounted,
                    scenario: scenario.name || 'Unknown'
                };
            } catch (error) {
                console.error('Error calculating scenario for year', year, ':', error);
                return {
                    fuels: [],
                    totalEnergy: 0,
                    gfiIntensity: 0,
                    bunkerCost: 0,
                    bunkerCostDiscounted: 0,
                    tier1Penalty: 0,
                    tier1PenaltyDiscounted: 0,
                    tier2Penalty: 0,
                    tier2PenaltyDiscounted: 0,
                    surplus: 0,
                    surplusDiscounted: 0,
                    totalCost: 0,
                    totalCostDiscounted: 0,
                    scenario: scenario.name || 'Unknown'
                };
            }
        }

        // Apply pilot fuel to LNG fuels in the mix
        function applyPilotFuelToMix(fuels, pilotFuelConfig) {
            const modifiedFuels = [];
            const pilotPercentage = parseFloat(pilotFuelConfig.percentage) / 100;

            fuels.forEach(fuel => {
                if (isLNGFuel(fuel.type)) {
                    const lngFuelEnergy = fuel.volume * parseFloat(fuelDataIMO[fuel.type][0]) * 1000000;
                    const pilotFuelEnergy = lngFuelEnergy * pilotPercentage;
                    const mainLngFuelEnergy = lngFuelEnergy * (1 - pilotPercentage);

                    const mainFuelVolume = mainLngFuelEnergy / (parseFloat(fuelDataIMO[fuel.type][0]) * 1000000);
                    const pilotFuelVolume = pilotFuelEnergy / (parseFloat(fuelDataIMO[pilotFuelConfig.type][0]) * 1000000);

                    modifiedFuels.push({
                        type: fuel.type,
                        volume: mainFuelVolume,
                        cost: fuel.cost
                    });

                    modifiedFuels.push({
                        type: pilotFuelConfig.type,
                        volume: pilotFuelVolume,
                        cost: pilotFuelConfig.cost
                    });
                } else {
                    modifiedFuels.push(fuel);
                }
            });

            return modifiedFuels;
        }

        // Optimize fuel mix for target - UPDATED FOR REPLACEMENT FUEL AND NUMERIC PARSING
        function optimizeFuelMixForTarget(scenario, target, baselineTotalEnergy, year) {
            try {
                const primaryFuel = scenario.primaryFuel;
                const secondaryFuel = scenario.secondaryFuel;
                const replacementFuel = scenario.replacementFuel;

                if (!primaryFuel || !fuelDataIMO[primaryFuel]) {
                    throw new Error("Invalid primary fuel");
                }

                const needsPilotFuel = isLNGFuel(primaryFuel) || isLNGFuel(replacementFuel);
                let effectiveSecondaryFuel = secondaryFuel;
                let pilotFuelConfig = null;

                if (needsPilotFuel && scenario.pilotFuel) {
                    if (isLNGFuel(replacementFuel)) {
                        effectiveSecondaryFuel = scenario.pilotFuel.type;
                        pilotFuelConfig = scenario.pilotFuel;
                    } else {
                        effectiveSecondaryFuel = secondaryFuel;
                        pilotFuelConfig = scenario.pilotFuel;
                    }
                }

                const primaryGHG = parseFloat(fuelDataIMO[primaryFuel][1]);
                const primaryLCV = parseFloat(fuelDataIMO[primaryFuel][0]);
                const primaryCost = parseFloat(fuelDataIMO[primaryFuel][3]);

                const secondaryGHG = fuelDataIMO[effectiveSecondaryFuel] ? parseFloat(fuelDataIMO[effectiveSecondaryFuel][1]) : 0;
                const secondaryLCV = fuelDataIMO[effectiveSecondaryFuel] ? parseFloat(fuelDataIMO[effectiveSecondaryFuel][0]) : 0;
                const secondaryCost = fuelDataIMO[effectiveSecondaryFuel] ? parseFloat(fuelDataIMO[effectiveSecondaryFuel][3]) : 0;

                const replacementGHG = fuelDataIMO[replacementFuel] ? parseFloat(fuelDataIMO[replacementFuel][1]) : 0;
                const replacementLCV = fuelDataIMO[replacementFuel] ? parseFloat(fuelDataIMO[replacementFuel][0]) : 0;
                const replacementCost = fuelDataIMO[replacementFuel] ? parseFloat(fuelDataIMO[replacementFuel][3]) : 0;

                const totalEnergyNeeded = baselineTotalEnergy;

                let fuels = [];

                if (needsPilotFuel) {
                    const pilotPercentage = (pilotFuelConfig ? parseFloat(pilotFuelConfig.percentage) : 5) / 100;

                    const denominator = primaryGHG - (1 - pilotPercentage) * replacementGHG - pilotPercentage * secondaryGHG;
                    let primaryEnergy = 0;
                    if (Math.abs(denominator) > 1e-9) {
                        primaryEnergy = totalEnergyNeeded * (target - (pilotPercentage * secondaryGHG) - (1 - pilotPercentage) * replacementGHG) / denominator;
                        primaryEnergy = Math.max(0, Math.min(primaryEnergy, totalEnergyNeeded));
                    } else if (target - (pilotPercentage * secondaryGHG) - (1 - pilotPercentage) * replacementGHG < 0) {
                        primaryEnergy = totalEnergyNeeded;
                    } else {
                        primaryEnergy = 0;
                    }

                    const remainingEnergy = totalEnergyNeeded - primaryEnergy;
                    const lngEnergy = remainingEnergy * (1 - pilotPercentage);
                    const pilotEnergy = remainingEnergy * pilotPercentage;

                    if (primaryEnergy > 0) {
                        fuels.push({
                            type: primaryFuel,
                            volume: primaryEnergy / (primaryLCV * 1000000),
                            cost: primaryCost
                        });
                    }

                    if (lngEnergy > 0 && replacementFuel) {
                        fuels.push({
                            type: replacementFuel,
                            volume: lngEnergy / (replacementLCV * 1000000),
                            cost: replacementCost
                        });
                    }

                    if (pilotEnergy > 0) {
                        fuels.push({
                            type: effectiveSecondaryFuel,
                            volume: pilotEnergy / (secondaryLCV * 1000000),
                            cost: secondaryCost
                        });
                    }
                } else {
                    if (effectiveSecondaryFuel) {
                        const secondaryEnergyFraction = 0.2;
                        const secondaryEnergy = totalEnergyNeeded * secondaryEnergyFraction;
                        const remainingEnergy = totalEnergyNeeded - secondaryEnergy;

                        const newTarget = (target * totalEnergyNeeded - secondaryGHG * secondaryEnergy) / remainingEnergy;

                        let primaryEnergyFraction = 0.6;
                        if (Math.abs(primaryGHG - replacementGHG) > 0.001) {
                            primaryEnergyFraction = Math.max(0, Math.min(1, (replacementGHG - newTarget) / (replacementGHG - primaryGHG)));
                        }

                        const primaryEnergy = remainingEnergy * primaryEnergyFraction;
                        const replacementEnergy = remainingEnergy * (1 - primaryEnergyFraction);

                        if (primaryEnergy > 0) {
                            fuels.push({
                                type: primaryFuel,
                                volume: primaryEnergy / (primaryLCV * 1000000),
                                cost: primaryCost
                            });
                        }

                        if (secondaryEnergy > 0) {
                            fuels.push({
                                type: effectiveSecondaryFuel,
                                volume: secondaryEnergy / (secondaryLCV * 1000000),
                                cost: secondaryCost
                            });
                        }

                        if (replacementEnergy > 0 && replacementFuel) {
                            fuels.push({
                                type: replacementFuel,
                                volume: replacementEnergy / (replacementLCV * 1000000),
                                cost: replacementCost
                            });
                        }
                    } else {
                        let primaryEnergyFraction = 0.6;
                        if (Math.abs(primaryGHG - replacementGHG) > 0.001) {
                            primaryEnergyFraction = Math.max(0, Math.min(1, (replacementGHG - target) / (replacementGHG - primaryGHG)));
                        }

                        const primaryEnergy = totalEnergyNeeded * primaryEnergyFraction;
                        const replacementEnergy = totalEnergyNeeded * (1 - primaryEnergyFraction);

                        if (primaryEnergy > 0) {
                            fuels.push({
                                type: primaryFuel,
                                volume: primaryEnergy / (primaryLCV * 1000000),
                                cost: primaryCost
                            });
                        }

                        if (replacementEnergy > 0 && replacementFuel) {
                            fuels.push({
                                type: replacementFuel,
                                volume: replacementEnergy / (replacementLCV * 1000000),
                                cost: replacementCost
                            });
                        }
                    }
                }

                return fuels;

            } catch (error) {
                console.error("Error in optimizeFuelMixForTarget:", error);
                return [{
                    type: scenario.primaryFuel || "HFO",
                    volume: baselineTotalEnergy / (fuelDataIMO[scenario.primaryFuel || "HFO"][0] * 1000000),
                    cost: fuelDataIMO[scenario.primaryFuel || "HFO"][3]
                }];
            }
        }

        // Main calculation function
        function calculateAndAnalyze() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('resultsSection').classList.add('hidden');

            setTimeout(() => {
                try {
                    const baselineFuels = getBaselineFuels();
                    const alternativeScenarios = getAlternativeScenarios();
                    const startYear = parseInt(document.getElementById('startYear').value) || 2028;
                    const vesselLifespan = parseInt(document.getElementById('vesselLifespan').value) || 25;
                    const baselineESD = parseFloat(document.getElementById("baselineESD").value) || 0;
                    const baselineCapex = parseFloat(document.getElementById("baselineCapex").value) || 0;
                    const baselineCapexDescription = document.getElementById("baselineCapexDescription").value || "";

                    console.log('Starting calculation with:', {
                        baselineFuels,
                        alternativeScenarios,
                        startYear,
                        vesselLifespan,
                        baselineESD
                    });

                    if (baselineFuels.length === 0) {
                        alert('Please add at least one baseline fuel with volume > 0.');
                        document.getElementById('loading').style.display = 'none';
                        return;
                    }

                    if (alternativeScenarios.length === 0) {
                        alert('Please add at least one alternative scenario.');
                        document.getElementById('loading').style.display = 'none';
                        return;
                    }

                    // Validate baseline fuels have valid data
                    for (const fuel of baselineFuels) {
                        if (!fuelDataIMO[fuel.type]) {
                            alert(`Invalid fuel type in baseline: ${fuel.type}`);
                            document.getElementById('loading').style.display = 'none';
                            return;
                        }
                    }

                    // Calculate baseline scenario
                    const baselineTotalEnergy = calculateTotalEnergy(baselineFuels);
                    console.log('Baseline total energy:', baselineTotalEnergy);

                    if (baselineTotalEnergy <= 0) {
                        alert('Baseline total energy is zero. Please check fuel volumes and types.');
                        document.getElementById('loading').style.display = 'none';
                        return;
                    }

                    const results = { baseline: {}, alternatives: {}, bestCase: {} };

                    // Calculate for each year
                    for (let i = 0; i < vesselLifespan; i++) {
                        const year = startYear + i;

                        try {
                            // Baseline calculation
                            const baselineResult = calculateScenarioForYear({
                                type: 'full',
                                fuels: baselineFuels,
                                esdSavings: baselineESD,
                                esdCapex: 0,
                                additionalCapex: baselineCapex,
                                capexDescription: baselineCapexDescription,
                                name: 'Baseline'
                            }, year, baselineTotalEnergy);

                            results.baseline[year] = baselineResult;

                            // Alternative scenarios calculation
                            results.alternatives[year] = {};
                            let bestScenario = { ...baselineResult };

                            alternativeScenarios.forEach(scenario => {
                                try {
                                    const altResult = calculateScenarioForYear(scenario, year, baselineTotalEnergy);
                                    results.alternatives[year][scenario.id] = altResult;

                                    // Check if this is the best scenario for this year
                                    if (altResult.totalCost < bestScenario.totalCost) {
                                        bestScenario = { ...altResult };
                                    }
                                } catch (scenarioError) {
                                    console.error(`Error calculating scenario ${scenario.id} for year ${year}:`, scenarioError);
                                }
                            });

                            results.bestCase[year] = bestScenario;

                        } catch (yearError) {
                            console.error(`Error calculating year ${year}:`, yearError);
                        }
                    }

                    console.log('Calculation results:', results);

                    calculationResults = results;
                    displayResults();
                    populateScenarioSelectors();
                    updateBreakdownComparison();
                    updateOptimizationTable();
                    populateYearSelectors();

                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('resultsSection').classList.remove('hidden');

                } catch (error) {
                    console.error('Main calculation error:', error);
                    alert(`Error in calculations: ${error.message}. Please check your inputs and try again.`);
                    document.getElementById('loading').style.display = 'none';
                }
            }, 100);
        }

        // Display results
        function displayResults() {
            const { baseline, bestCase } = calculationResults;

            // Calculate totals
            const baselineTotal = Object.values(baseline).reduce((sum, year) => sum + year.totalCost, 0);
            const bestCaseTotal = Object.values(bestCase).reduce((sum, year) => sum + year.totalCost, 0);
            const totalSavings = baselineTotal - bestCaseTotal;

            // Calculate discounted totals
            const baselineTotalDiscounted = Object.values(baseline).reduce((sum, year) => sum + year.totalCostDiscounted, 0);
            const bestCaseTotalDiscounted = Object.values(bestCase).reduce((sum, year) => sum + year.totalCostDiscounted, 0);
            const totalSavingsDiscounted = baselineTotalDiscounted - bestCaseTotalDiscounted;

            const roi = (totalSavings / baselineTotal * 100).toFixed(2);

            // Update summary cards
            document.getElementById("bestCaseCost").textContent = `$${bestCaseTotal.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}`;
            document.getElementById("baselineCost").textContent = `$${baselineTotal.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}`;
            document.getElementById("totalSavings").textContent = `$${totalSavings.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}`;
            document.getElementById("totalSavingsDiscounted").textContent = `$${totalSavingsDiscounted.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })}`;
            document.getElementById("roi").textContent = `${roi}%`;

            // Create detailed results text in table format
            const resultText = `
IMO GFI ROI ANALYSIS RESULTS
==================================================

<table style="width: 100%; border-collapse: collapse; margin: 20px 0;">
<tr style="background-color: #f8f9fa; border: 1px solid #dee2e6;">
<th style="padding: 8px; text-align: left; border: 1px solid #dee2e6;">Metric</th>
<th style="padding: 8px; text-align: right; border: 1px solid #dee2e6;">Value</th>
</tr>
<tr style="border: 1px solid #dee2e6;">
<td style="padding: 8px; border: 1px solid #dee2e6;">Baseline Total Cost</td>
<td style="padding: 8px; text-align: right; border: 1px solid #dee2e6;">$${baselineTotal.toLocaleString()}</td>
</tr>
<tr style="background-color: #f8f9fa; border: 1px solid #dee2e6;">
<td style="padding: 8px; border: 1px solid #dee2e6;">Baseline Total Cost (Discounted)</td>
<td style="padding: 8px; text-align: right; border: 1px solid #dee2e6;">$${baselineTotalDiscounted.toLocaleString()}</td>
</tr>
<tr style="border: 1px solid #dee2e6;">
<td style="padding: 8px; border: 1px solid #dee2e6;">Best Case Total Cost</td>
<td style="padding: 8px; text-align: right; border: 1px solid #dee2e6;">$${bestCaseTotal.toLocaleString()}</td>
</tr>
<tr style="background-color: #f8f9fa; border: 1px solid #dee2e6;">
<td style="padding: 8px; border: 1px solid #dee2e6;">Best Case Total Cost (Discounted)</td>
<td style="padding: 8px; text-align: right; border: 1px solid #dee2e6;">$${bestCaseTotalDiscounted.toLocaleString()}</td>
</tr>
<tr style="border: 1px solid #dee2e6;">
<td style="padding: 8px; border: 1px solid #dee2e6;">Total Savings</td>
<td style="padding: 8px; text-align: right; border: 1px solid #dee2e6; color: #28a745; font-weight: bold;">$${totalSavings.toLocaleString()}</td>
</tr>
<tr style="background-color: #f8f9fa; border: 1px solid #dee2e6;">
<td style="padding: 8px; border: 1px solid #dee2e6;">Total Savings (Discounted)</td>
<td style="padding: 8px; text-align: right; border: 1px solid #dee2e6; color: #28a745; font-weight: bold;">$${totalSavingsDiscounted.toLocaleString()}</td>
</tr>
<tr style="border: 1px solid #dee2e6;">
<td style="padding: 8px; border: 1px solid #dee2e6;">ROI</td>
<td style="padding: 8px; text-align: right; border: 1px solid #dee2e6; color: #667eea; font-weight: bold;">${roi}%</td>
</tr>
</table>

<h4 style="margin-top: 30px; margin-bottom: 15px; color: #2c3e50;">YEAR-BY-YEAR BEST SCENARIOS:</h4>
<table style="width: 100%; border-collapse: collapse; margin: 20px 0; font-size: 0.9rem;">
<tr style="background-color: #f8f9fa; border: 1px solid #dee2e6;">
<th style="padding: 8px; text-align: center; border: 1px solid #dee2e6;">Year</th>
<th style="padding: 8px; text-align: left; border: 1px solid #dee2e6;">Best Scenario</th>
<th style="padding: 8px; text-align: right; border: 1px solid #dee2e6;">Total Cost</th>
<th style="padding: 8px; text-align: right; border: 1px solid #dee2e6;">Discounted Cost</th>
</tr>
${Object.keys(bestCase).map((year, index) => {
    const rowStyle = index % 2 === 0 ? 'background-color: #f8f9fa;' : '';
    return `<tr style="${rowStyle} border: 1px solid #dee2e6;">
<td style="padding: 8px; text-align: center; border: 1px solid #dee2e6;">${year}</td>
<td style="padding: 8px; border: 1px solid #dee2e6;">${bestCase[year].scenario}</td>
<td style="padding: 8px; text-align: right; border: 1px solid #dee2e6;">$${bestCase[year].totalCost.toLocaleString()}</td>
<td style="padding: 8px; text-align: right; border: 1px solid #dee2e6;">$${bestCase[year].totalCostDiscounted.toLocaleString()}</td>
</tr>`;
}).join('')}
</table>

FUEL MIX BREAKDOWN (Baseline):
${Object.keys(baseline).map(year => {
    const fuels = baseline[year].fuels.map(f => `${f.type}: ${f.volume.toFixed(1)}MT`).join(", ");
    return `${year}: ${fuels}`;
}).join("\n")}

NOTE: Check other tabs for detailed analysis and comparisons.
            `;

            document.getElementById('resultsText').innerHTML = resultText;

            // Create main chart
            createMainChart();

            // Create cumulative savings chart
            createCumulativeSavingsChart();
        }

        // Create main comparison chart - FIXED CHART DESTRUCTION
        function createMainChart() {
            const ctx = document.getElementById('mainChart').getContext('2d');
            const { baseline, bestCase } = calculationResults;

            const years = Object.keys(baseline).map(year => parseInt(year)).sort((a, b) => a - b);

            // Prepare data for stacked bar chart
            const baselineBunker = years.map(year => baseline[year].bunkerCost);
            const baselineTier1 = years.map(year => baseline[year].tier1Penalty);
            const baselineTier2 = years.map(year => baseline[year].tier2Penalty);
            const baselineSurplus = years.map(year => -baseline[year].surplus); // Negative for display

            const bestCaseBunker = years.map(year => bestCase[year].bunkerCost);
            const bestCaseTier1 = years.map(year => bestCase[year].tier1Penalty);
            const bestCaseTier2 = years.map(year => bestCase[year].tier2Penalty);
            const bestCaseSurplus = years.map(year => -bestCase[year].surplus); // Negative for display

            // Destroy existing chart if it exists and has destroy method
            if (window.mainChart && typeof window.mainChart.destroy === 'function') {
                window.mainChart.destroy();
            }

            window.mainChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: years,
                    datasets: [
                        {
                            label: 'Baseline Bunker Cost',
                            data: baselineBunker,
                            backgroundColor: 'rgba(54, 162, 235, 0.8)',
                            stack: 'baseline'
                        },
                        {
                            label: 'Baseline Tier 1 Penalty',
                            data: baselineTier1,
                            backgroundColor: 'rgba(255, 99, 132, 0.8)',
                            stack: 'baseline'
                        },
                        {
                            label: 'Baseline Tier 2 Penalty',
                            data: baselineTier2,
                            backgroundColor: 'rgba(255, 159, 64, 0.8)',
                            stack: 'baseline'
                        },
                        {
                            label: 'Baseline Surplus',
                            data: baselineSurplus,
                            backgroundColor: 'rgba(75, 192, 192, 0.8)',
                            stack: 'baseline'
                        },
                        {
                            label: 'Best Case Bunker Cost',
                            data: bestCaseBunker,
                            backgroundColor: 'rgba(153, 102, 255, 0.8)',
                            stack: 'bestcase'
                        },
                        {
                            label: 'Best Case Tier 1 Penalty',
                            data: bestCaseTier1,
                            backgroundColor: 'rgba(255, 205, 86, 0.8)',
                            stack: 'bestcase'
                        },
                        {
                            label: 'Best Case Tier 2 Penalty',
                            data: bestCaseTier2,
                            backgroundColor: 'rgba(201, 203, 207, 0.8)',
                            stack: 'bestcase'
                        },
                        {
                            label: 'Best Case Surplus',
                            data: bestCaseSurplus,
                            backgroundColor: 'rgba(54, 162, 235, 0.6)',
                            stack: 'bestcase'
                        },
                        {
                            label: 'Baseline Total Cost',
                            data: years.map(year => baseline[year].totalCost),
                            borderColor: 'rgba(0, 0, 0, 1)',
                            backgroundColor: 'rgba(0, 0, 0, 0)',
                            type: 'line',
                            pointRadius: 5,
                            pointBackgroundColor: 'rgba(0, 0, 0, 1)',
                            yAxisID: 'y',
                            order: 0 // Draw line on top
                        },
                        {
                            label: 'Best Case Total Cost',
                            data: years.map(year => bestCase[year].totalCost),
                            borderColor: 'rgba(255, 0, 0, 1)',
                            backgroundColor: 'rgba(255, 0, 0, 0)',
                            type: 'line',
                            pointRadius: 5,
                            pointBackgroundColor: 'rgba(255, 0, 0, 1)',
                            yAxisID: 'y',
                            order: 0 // Draw line on top
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Year'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Cost (USD)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return '$' + (value / 1000000).toFixed(1) + 'M';
                                }
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Baseline vs Best Case Comparison'
                        },
                        legend: {
                            display: true,
                            position: 'bottom',
                            labels: {
                                boxWidth: 20,
                                padding: 15,
                                usePointStyle: false,
                                generateLabels: function(chart) {
                                    const original = Chart.defaults.plugins.legend.labels.generateLabels;
                                    const labels = original.call(this, chart);

                                    // Ensure colors are properly displayed
                                    labels.forEach((label, index) => {
                                        const dataset = chart.data.datasets[index];
                                        if (dataset) {
                                            if (dataset.type === 'line') {
                                                label.fillStyle = dataset.borderColor;
                                                label.strokeStyle = dataset.borderColor;
                                            } else {
                                                label.fillStyle = dataset.backgroundColor;
                                                label.strokeStyle = dataset.backgroundColor;
                                            }
                                        }
                                    });

                                    return labels;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Populate scenario selectors
        function populateScenarioSelectors() {
            const scenarios = ['baseline', 'bestCase'];
            const alternativeScenarios = getAlternativeScenarios();

            alternativeScenarios.forEach(scenario => {
                scenarios.push(`alt_${scenario.id}`);
            });

            const selectors = ['breakdownScenario1', 'breakdownScenario2', 'sensitivityFromScenario', 'sensitivityToScenario', 'cumulativeScenario1', 'cumulativeScenario2'];

            selectors.forEach(selectorId => {
                const selector = document.getElementById(selectorId);
                if (selector) {
                    const currentValue = selector.value;
                    selector.innerHTML = '';

                    selector.innerHTML += `<option value="baseline">Baseline</option>`;
                    selector.innerHTML += `<option value="bestCase">Best Case</option>`;

                    alternativeScenarios.forEach(scenario => {
                        selector.innerHTML += `<option value="alt_${scenario.id}">${scenario.name}</option>`;
                    });

                    // Restore previous selection if valid
                    if (scenarios.includes(currentValue)) {
                        selector.value = currentValue;
                    }
                }
            });
        }

        // Update breakdown comparison
        function updateBreakdownComparison() {
            const scenario1Element = document.getElementById('breakdownScenario1');
            const scenario2Element = document.getElementById('breakdownScenario2');

            if (!scenario1Element || !scenario2Element || !calculationResults.baseline) return;

            const scenario1 = scenario1Element.value;
            const scenario2 = scenario2Element.value;

            const tbody = document.getElementById('yearlyTableBody');
            if (!tbody) return;

            tbody.innerHTML = '';

            const discountRate = parseFloat(document.getElementById('discountRate').value) || 7;
            const years = Object.keys(calculationResults.baseline).map(year => parseInt(year)).sort((a, b) => a - b);

            let cumulativeDCF = 0;

            years.forEach((year, index) => {
                const data1 = getScenarioData(scenario1, year);
                const data2 = getScenarioData(scenario2, year);

                const costDifference = data2.totalCost - data1.totalCost;
                const costDifferenceDiscounted = data2.totalCostDiscounted - data1.totalCostDiscounted;
                cumulativeDCF += costDifferenceDiscounted;

                const row = tbody.insertRow();
                const cells = [
                    year,
                    data1.bunkerCost || 0,
                    data1.tier1Penalty || 0,
                    data1.tier2Penalty || 0,
                    data1.surplus || 0,
                    data1.totalCost || 0,
                    data1.totalCostDiscounted || 0,
                    data2.bunkerCost || 0,
                    data2.tier1Penalty || 0,
                    data2.tier2Penalty || 0,
                    data2.surplus || 0,
                    data2.totalCost || 0,
                    data2.totalCostDiscounted || 0,
                    costDifference,
                    costDifferenceDiscounted,
                    cumulativeDCF
                ];

                cells.forEach((value, cellIndex) => {
                    const cell = row.insertCell();
                    if (cellIndex === 0) {
                        cell.textContent = value;
                    } else {
                        cell.textContent = '$' + value.toLocaleString();

                        // Apply color coding
                        if (cellIndex >= 13) { // Difference columns
                            if (value < 0) {
                                cell.classList.add('positive');
                            } else if (value > 0) {
                                cell.classList.add('negative');
                            }
                        } else if ([4, 10].includes(cellIndex) && value > 0) { // Surplus
                            cell.classList.add('positive');
                        } else if ([2, 3, 8, 9].includes(cellIndex) && value > 0) { // Penalties
                            cell.classList.add('negative');
                        }
                    }
                });
            });

            // Create breakdown chart
            createBreakdownChart(scenario1, scenario2);
        }

        // Get scenario data for a specific year
        function getScenarioData(scenarioKey, year) {
            if (scenarioKey === 'baseline') {
                return calculationResults.baseline[year] || {};
            } else if (scenarioKey === 'bestCase') {
                return calculationResults.bestCase[year] || {};
            } else if (scenarioKey.startsWith('alt_')) {
                const altId = parseInt(scenarioKey.split('_')[1]);
                return calculationResults.alternatives[year]?.[altId] || {};
            }
            return {};
        }

        // Create breakdown chart - FIXED CHART DESTRUCTION
        function createBreakdownChart(scenario1, scenario2) {
            const ctx = document.getElementById('breakdownChart').getContext('2d');
            const years = Object.keys(calculationResults.baseline).map(year => parseInt(year)).sort((a, b) => a - b);

            const data1 = years.map(year => {
                const data = getScenarioData(scenario1, year);
                return {
                    bunker: data.bunkerCost || 0,
                    tier1: data.tier1Penalty || 0,
                    tier2: data.tier2Penalty || 0,
                    surplus: -(data.surplus || 0)
                };
            });

            const data2 = years.map(year => {
                const data = getScenarioData(scenario2, year);
                return {
                    bunker: data.bunkerCost || 0,
                    tier1: data.tier1Penalty || 0,
                    tier2: data.tier2Penalty || 0,
                    surplus: -(data.surplus || 0)
                };
            });

            // Destroy existing chart if it exists and has destroy method
            if (window.breakdownChart && typeof window.breakdownChart.destroy === 'function') {
                window.breakdownChart.destroy();
            }

            window.breakdownChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: years,
                    datasets: [
                        {
                            label: `${scenario1} - Bunker Cost`,
                            data: data1.map(d => d.bunker),
                            backgroundColor: 'rgba(54, 162, 235, 0.8)',
                            stack: 'scenario1'
                        },
                        {
                            label: `${scenario1} - Tier 1 Penalty`,
                            data: data1.map(d => d.tier1),
                            backgroundColor: 'rgba(255, 99, 132, 0.8)',
                            stack: 'scenario1'
                        },
                        {
                            label: `${scenario1} - Tier 2 Penalty`,
                            data: data1.map(d => d.tier2),
                            backgroundColor: 'rgba(255, 159, 64, 0.8)',
                            stack: 'scenario1'
                        },
                        {
                            label: `${scenario1} - Surplus Revenue`,
                            data: data1.map(d => d.surplus),
                            backgroundColor: 'rgba(75, 192, 192, 0.8)',
                            stack: 'scenario1'
                        },
                        {
                            label: `${scenario2} - Bunker Cost`,
                            data: data2.map(d => d.bunker),
                            backgroundColor: 'rgba(153, 102, 255, 0.8)',
                            stack: 'scenario2'
                        },
                        {
                            label: `${scenario2} - Tier 1 Penalty`,
                            data: data2.map(d => d.tier1),
                            backgroundColor: 'rgba(255, 205, 86, 0.8)',
                            stack: 'scenario2'
                        },
                        {
                            label: `${scenario2} - Tier 2 Penalty`,
                            data: data2.map(d => d.tier2),
                            backgroundColor: 'rgba(201, 203, 207, 0.8)',
                            stack: 'scenario2'
                        },
                        {
                            label: `${scenario2} - Surplus Revenue`,
                            data: data2.map(d => d.surplus),
                            backgroundColor: 'rgba(54, 162, 235, 0.6)',
                            stack: 'scenario2'
                        },
                        {
                            label: `${scenario1} - Total Cost (Line)`,
                            data: years.map(year => getScenarioData(scenario1, year).totalCost),
                            borderColor: `rgba(54, 162, 235, 1)`,
                            backgroundColor: `rgba(54, 162, 235, 0)`,
                            type: 'line',
                            pointRadius: 5,
                            pointBackgroundColor: `rgba(54, 162, 235, 1)`,
                            yAxisID: 'y',
                            order: 0
                        },
                        {
                            label: `${scenario2} - Total Cost (Line)`,
                            data: years.map(year => getScenarioData(scenario2, year).totalCost),
                            borderColor: `rgba(153, 102, 255, 1)`,
                            backgroundColor: `rgba(153, 102, 255, 0)`,
                            type: 'line',
                            pointRadius: 5,
                            pointBackgroundColor: `rgba(153, 102, 255, 1)`,
                            yAxisID: 'y',
                            order: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Year'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Cost (USD)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return '$' + (value / 1000000).toFixed(1) + 'M';
                                }
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: `Yearly Cost Breakdown: ${scenario1} vs ${scenario2}`
                        },
                        legend: {
                            display: false // Hide default legend, we'll create a custom table below
                        }
                    }
                }
            });

            // Create custom legend table below the chart
            createBreakdownLegendTable(scenario1, scenario2);
        }

        // Create breakdown legend table
        function createBreakdownLegendTable(scenario1, scenario2) {
            // Find or create legend container
            let legendContainer = document.getElementById('breakdownLegendTable');
            if (!legendContainer) {
                legendContainer = document.createElement('div');
                legendContainer.id = 'breakdownLegendTable';
                legendContainer.style.marginTop = '20px';

                // Insert after the chart container
                const chartContainer = document.getElementById('breakdownChart').parentElement;
                chartContainer.parentElement.insertBefore(legendContainer, chartContainer.nextSibling);
            }

            legendContainer.innerHTML = `
                <h4 style="margin-bottom: 10px;">Chart Legend</h4>
                <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                    <thead>
                        <tr style="background-color: #f8f9fa;">
                            <th style="padding: 8px; border: 1px solid #dee2e6; text-align: left;">Component</th>
                            <th style="padding: 8px; border: 1px solid #dee2e6; text-align: center;">${scenario1}</th>
                            <th style="padding: 8px; border: 1px solid #dee2e6; text-align: center;">${scenario2}</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td style="padding: 8px; border: 1px solid #dee2e6;">Bunker Cost</td>
                            <td style="padding: 8px; border: 1px solid #dee2e6; text-align: center;">
                                <span style="display: inline-block; width: 20px; height: 15px; background-color: rgba(54, 162, 235, 0.8); border: 1px solid #ccc; margin-right: 5px;"></span>
                                Stacked Bar
                            </td>
                            <td style="padding: 8px; border: 1px solid #dee2e6; text-align: center;">
                                <span style="display: inline-block; width: 20px; height: 15px; background-color: rgba(153, 102, 255, 0.8); border: 1px solid #ccc; margin-right: 5px;"></span>
                                Stacked Bar
                            </td>
                        </tr>
                        <tr style="background-color: #f8f9fa;">
                            <td style="padding: 8px; border: 1px solid #dee2e6;">Tier 1 Penalty</td>
                            <td style="padding: 8px; border: 1px solid #dee2e6; text-align: center;">
                                <span style="display: inline-block; width: 20px; height: 15px; background-color: rgba(255, 99, 132, 0.8); border: 1px solid #ccc; margin-right: 5px;"></span>
                                Stacked Bar
                            </td>
                            <td style="padding: 8px; border: 1px solid #dee2e6; text-align: center;">
                                <span style="display: inline-block; width: 20px; height: 15px; background-color: rgba(255, 205, 86, 0.8); border: 1px solid #ccc; margin-right: 5px;"></span>
                                Stacked Bar
                            </td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid #dee2e6;">Tier 2 Penalty</td>
                            <td style="padding: 8px; border: 1px solid #dee2e6; text-align: center;">
                                <span style="display: inline-block; width: 20px; height: 15px; background-color: rgba(255, 159, 64, 0.8); border: 1px solid #ccc; margin-right: 5px;"></span>
                                Stacked Bar
                            </td>
                            <td style="padding: 8px; border: 1px solid #dee2e6; text-align: center;">
                                <span style="display: inline-block; width: 20px; height: 15px; background-color: rgba(201, 203, 207, 0.8); border: 1px solid #ccc; margin-right: 5px;"></span>
                                Stacked Bar
                            </td>
                        </tr>
                        <tr style="background-color: #f8f9fa;">
                            <td style="padding: 8px; border: 1px solid #dee2e6;">Surplus Revenue</td>
                            <td style="padding: 8px; border: 1px solid #dee2e6; text-align: center;">
                                <span style="display: inline-block; width: 20px; height: 15px; background-color: rgba(75, 192, 192, 0.8); border: 1px solid #ccc; margin-right: 5px;"></span>
                                Stacked Bar
                            </td>
                            <td style="padding: 8px; border: 1px solid #dee2e6; text-align: center;">
                                <span style="display: inline-block; width: 20px; height: 15px; background-color: rgba(54, 162, 235, 0.6); border: 1px solid #ccc; margin-right: 5px;"></span>
                                Stacked Bar
                            </td>
                        </tr>
                        <tr>
                            <td style="padding: 8px; border: 1px solid #dee2e6;">Total Cost</td>
                            <td style="padding: 8px; border: 1px solid #dee2e6; text-align: center;">
                                <span style="display: inline-block; width: 20px; height: 3px; background-color: rgba(54, 162, 235, 1); margin-right: 5px;"></span>
                                Line Chart
                            </td>
                            <td style="padding: 8px; border: 1px solid #dee2e6; text-align: center;">
                                <span style="display: inline-block; width: 20px; height: 3px; background-color: rgba(153, 102, 255, 1); margin-right: 5px;"></span>
                                Line Chart
                            </td>
                        </tr>
                    </tbody>
                </table>
            `;
        }

        // Update optimization table
        function updateOptimizationTable() {
            const { bestCase } = calculationResults;
            const tbody = document.getElementById('optimizationTableBody');
            if (!tbody || !bestCase) return;

            tbody.innerHTML = '';

            Object.keys(bestCase).forEach(year => {
                const data = bestCase[year];
                const row = tbody.insertRow();

                const fuelMix = data.fuels ? data.fuels.map(f => `${f.type}: ${f.volume.toFixed(1)}MT`).join(', ') : 'No fuels';

                const cells = [
                    year,
                    data.scenario || 'Unknown',
                    fuelMix,
                    '$' + (data.bunkerCost || 0).toLocaleString(),
                    '$' + ((data.tier1Penalty || 0) + (data.tier2Penalty || 0)).toLocaleString(),
                    '$' + (data.surplus || 0).toLocaleString(),
                    '$' + (data.totalCost || 0).toLocaleString()
                ];

                cells.forEach((value, index) => {
                    const cell = row.insertCell();
                    cell.textContent = value;
                    if (index === 4 && (data.surplus || 0) > 0) cell.classList.add('positive');
                    if (index === 5 && ((data.tier1Penalty || 0) + (data.tier2Penalty || 0)) > 0) cell.classList.add('negative');
                });
            });
        }

        // Calculate price sensitivity
        function calculatePriceSensitivity() {
            const yearElement = document.getElementById('sensitivityYear');
            const fromScenarioElement = document.getElementById('sensitivityFromScenario');
            const toScenarioElement = document.getElementById('sensitivityToScenario');

            if (!yearElement || !fromScenarioElement || !toScenarioElement) return;

            const year = parseInt(yearElement.value);
            const fromScenario = fromScenarioElement.value;
            const toScenario = toScenarioElement.value;

            const fromData = getScenarioData(fromScenario, year);
            const toData = getScenarioData(toScenario, year);

            const costDifference = (toData.totalCost || 0) - (fromData.totalCost || 0);

            // Get primary fuel from toScenario
            let primaryFuelVolume = 0;
            let primaryFuelType = '';

            if (toData.fuels && toData.fuels.length > 0) {
                const primaryFuel = toData.fuels[0];
                primaryFuelVolume = primaryFuel.volume;
                primaryFuelType = primaryFuel.type;
            }

            const priceChange = primaryFuelVolume > 0 ? costDifference / primaryFuelVolume : 0;
            const currentPrice = fuelDataIMO[primaryFuelType]?.[3] || 0;
            const acceptablePrice = currentPrice - priceChange;

            // Get reference fuel price (assuming first fuel in fromScenario)
            let referenceFuelPrice = 0;
            let referenceFuelType = '';
            if (fromData.fuels && fromData.fuels.length > 0) {
                referenceFuelPrice = fuelDataIMO[fromData.fuels[0].type]?.[3] || 0;
                referenceFuelType = fromData.fuels[0].type;
            }

            const spread = acceptablePrice - referenceFuelPrice;

            const resultsDiv = document.getElementById('sensitivityResults');
            if (resultsDiv) {
                resultsDiv.classList.remove('hidden');
                resultsDiv.innerHTML = `
                    <h5>Price Sensitivity Results for ${year}</h5>
                    <div class="input-grid">
                        <div class="card">
                            <h6>Cost Difference</h6>
                            <p>$${costDifference.toLocaleString()}</p>
                        </div>
                        <div class="card">
                            <h6>Required Price Change</h6>
                            <p>$${priceChange.toFixed(2)}/MT decrease</p>
                            <p>${(Math.abs(priceChange/currentPrice)*100).toFixed(1)}% decrease</p>
                        </div>
                        <div class="card">
                            <h6>Acceptable ${primaryFuelType} Price</h6>
                            <p>$${acceptablePrice.toFixed(2)}/MT</p>
                        </div>
                        <div class="card">
                            <h6>Spread vs ${referenceFuelType}</h6>
                            <p>$${spread.toFixed(2)}/MT</p>
                        </div>
                    </div>
                `;
            }
        }

        // Add CAPEX
        function addCapex() {
            const yearElement = document.getElementById('capexYear');
            const amountElement = document.getElementById('capexAmount');

            if (!yearElement || !amountElement) return;

            const year = parseInt(yearElement.value);
            const amount = parseFloat(amountElement.value) || 0;

            if (amount > 0) {
                capexInputs.push({ year, amount });
                updateCapexList();
                amountElement.value = '0';
            }
        }

        // Update CAPEX list
        function updateCapexList() {
            const container = document.getElementById('capexList');
            if (!container) return;

            container.innerHTML = '';

            capexInputs.forEach((capex, index) => {
                const div = document.createElement('div');
                div.className = 'capex-item';
                div.innerHTML = `
                    <span>${capex.year}: $${capex.amount.toLocaleString()}</span>
                    <button class="btn btn-danger btn-small" onclick="removeCapex(${index})">Remove</button>
                `;
                container.appendChild(div);
            });
        }

        // Remove CAPEX
        function removeCapex(index) {
            capexInputs.splice(index, 1);
            updateCapexList();
        }

        // Export to Excel (simplified)
        function exportToExcel() {
            if (!calculationResults.baseline) {
                alert('Please run calculations first before exporting.');
                return;
            }

            // This would implement the full Excel export functionality
            alert('Excel export functionality would be implemented here with detailed sheets for all analysis results.');
        }

        // Initialize the application when page loads
        window.addEventListener("DOMContentLoaded", init);
        // Global variable to hold the pre-calculated sea route data
        let CALCULATED_SEA_ROUTES = null;
        let isSeaRouteDataLoaded = false; // Flag to track loading status

        // Function to load pre-calculated sea route data
        function loadSeaRouteData() {
            console.log("Attempting to load sea route data...");
            fetch('calculated_sea_routes_for_accepted_ports.json') // Assumes the file is in the same directory
                .then(response => {
                    console.log("Fetch response for sea routes:", response.status, response.ok);
                    if (!response.ok) {
                        if (response.status === 404) {
                            throw new Error("Sea route data file 'calculated_sea_routes.json' not found. Routes will be straight lines.");
                        } else {
                            throw new Error(`Failed to load sea route data. HTTP error! status: ${response.status}`);
                        }
                    }
                    return response.json();
                })
                .then(data => {
                    CALCULATED_SEA_ROUTES = data;
                    isSeaRouteDataLoaded = true;
                    console.log("Sea route data loaded successfully:", Object.keys(CALCULATED_SEA_ROUTES).length, "routes");
                })
                .catch(error => {
                    console.error('Error loading sea route ', error);
                    alert("Warning: " + error.message); // Alert user about fallback
                    isSeaRouteDataLoaded = true; // Mark as loaded (even if failed) to stop retries
                });
        }
        // --- BEGIN: RAG Integration Functions ---

            /**
             * Generic function to send data to the RAG API and update a specific section of the page.
             * @param {Object} data - The data object to send to the RAG API.
             * @param {string} resultSectionId - The ID of the main results container div (e.g., 'chartering-rag-results').
             * @param {string} briefingContentId - The ID of the div to put the briefing text into.
             * @param {string} pdfLinksListId - The ID of the ul to put the PDF links into.
             */
        /**
         * Generic function to send data to the RAG API and update a specific section of the page.
         * @param {Object} data - The data object to send to the RAG API.
         * @param {string} resultSectionId - The ID of the main results container div (e.g., 'chartering-rag-results').
         * @param {string} briefingContentId - The ID of the div to put the briefing text into.
         * @param {string} pdfLinksListId - The ID of the ul to put the PDF links into.
         */
        function queryRAGAndDisplay(data, resultSectionId, briefingContentId, pdfLinksListId) {
            console.log("DEBUG: queryRAGAndDisplay called for", resultSectionId);
            const RAG_API_URL = 'http://127.0.0.1:5000/api/query'; 

            const resultSection = document.getElementById(resultSectionId);
            const briefingContent = document.getElementById(briefingContentId);
            const pdfLinksList = document.getElementById(pdfLinksListId);

            // --- VALIDATE INPUT ELEMENTS ---
            if (!resultSection || !briefingContent || !pdfLinksList) {
                const errorMsg = `RAG Display Error: Could not find result elements for IDs: ${resultSectionId}, ${briefingContentId}, ${pdfLinksListId}`;
                console.error(errorMsg);
                // Attempt to show a basic error in the briefing area if the main section exists
                if (resultSection && briefingContent) {
                    resultSection.classList.remove('hidden');
                    briefingContent.textContent = errorMsg;
                }
                return;
            }
            // --- END VALIDATION ---

            // --- SHOW LOADING INDICATOR ---
            resultSection.classList.remove('hidden');
            briefingContent.textContent = 'Consulting maritime intelligence...';
            pdfLinksList.innerHTML = ''; // Clear any previous content
            // --- END LOADING ---

            console.log(`Sending data to RAG API for ${resultSectionId}:`, data);

            // --- SEND REQUEST TO RAG API ---
            fetch(RAG_API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                    // Add 'Authorization': 'Bearer YOUR_API_KEY_HERE' if needed
                },
                body: JSON.stringify(data)
            })
            .then(response => {
                console.log("DEBUG: Fetch response received for", resultSectionId);
                if (!response.ok) {
                    // Handle specific HTTP errors if needed, or let the .catch handle network issues
                    throw new Error(`API Error: ${response.status} - ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                console.log("DEBUG: Data processing starts for", resultSectionId);
                console.log(`Received data from RAG API for ${resultSectionId}:`, data);

                // --- HANDLE API RESPONSE ---
                if (data.error) {
                    console.warn(`RAG API returned an error for ${resultSectionId}:`, data.error);
                    briefingContent.textContent = `RAG Error: ${data.error}`;
                    pdfLinksList.innerHTML = ''; // Ensure PDF list is cleared on error
                    return; // Stop processing
                }

                // --- DISPLAY BRIEFING ---
                // Use innerHTML to allow for basic formatting (like line breaks) in the LLM response.
                // This assumes the LLM outputs plain text with \n for newlines or simple HTML.
                // If the LLM outputs complex/untrusted HTML, use textContent and add CSS for styling.
                const ragBriefing = data.briefing || "Sorry, I couldn't formulate a response based on the available data.";
                briefingContent.innerHTML = ragBriefing; // Use innerHTML for potential formatting
                // --- END DISPLAY BRIEFING ---

                // --- DISPLAY PDF LINKS ---
                pdfLinksList.innerHTML = ''; // Clear loading message or previous links
                if (data.pdf_files && Array.isArray(data.pdf_files) && data.pdf_files.length > 0) {
                    data.pdf_files.forEach(pdfFileName => {
                        // IMPORTANT: Adjust the path prefix so the links work correctly in your browser.
                        // This depends on how your main web server serves static files.
                        const fullPath = `Documents/${pdfFileName}`; // <--- ADJUST THIS PATH AS NEEDED

                        const listItem = document.createElement('li');
                        const link = document.createElement('a');
                        link.href = fullPath;
                        link.textContent = pdfFileName;
                        link.target = "_blank"; // Open in new tab
                        listItem.appendChild(link);
                        pdfLinksList.appendChild(listItem);
                    });
                } else {
                    const listItem = document.createElement('li');
                    listItem.textContent = 'No specific documents referenced.';
                    pdfLinksList.appendChild(listItem);
                }
                // --- END DISPLAY PDF LINKS ---

                console.log("DEBUG: Data processing finished successfully for", resultSectionId);

            })
            .catch(error => {
                // --- HANDLE FETCH/NETWORK/JAVASCRIPT ERRORS ---
                console.error(`Error querying RAG for ${resultSectionId}:`, error);
                // ONLY update the content area, DO NOT navigate away or change the main page view
                briefingContent.textContent = `Error connecting to analysis engine: ${error.message || 'Unknown error'}`;
                pdfLinksList.innerHTML = ''; // Clear list on error
                // DO NOT call showPage() or anything that changes the main page view here
                // --- END ERROR HANDLING ---
            });
            // Note: The function ends here. The asynchronous fetch continues.
            console.log("DEBUG: queryRAGAndDisplay function initiated fetch for", resultSectionId);
        }
        // --- END queryRAGAndDisplay ---

            /**
             * Triggers RAG analysis for Chartering Requirements.
             * Gathers data from the chartering form.
             */
            function analyzeCharteringWithRAG() {
                // --- GATHER DATA FROM CHARTERING FORM ---
                // You need to replace these placeholder IDs with the actual IDs from your chartering form inputs
                const charteringData = {
                    "Cargo Type": document.getElementById('cargoType')?.value || "N/A", // Matches request.form.get("Cargo Type")
                    "From Port": "N/A", // Needs implementation if required
                    "To Port": "N/A",   // Needs implementation if required
                    "Loading Port": "N/A",
                    "Discharging Port": "N/A",
                    "ship_type": "N/A",
                    "dwt": "N/A",
                    "length": "N/A",
                    "width": "N/A",
                    "draft": "N/A",
                    "CAPEX Description": "N/A",
                    "Fuel Type": "N/A", // Or get from a specific input if it exists
                    "Laycan Start": "N/A",
                    "Laycan End": "N/A",
                    "Pooling Price": "N/A"
                };
                console.log("Sending Chartering Data to RAG:", charteringData); // For debugging

                // --- END GATHER DATA ---

                // Call the generic RAG display function with the collected data
                // Make sure the element IDs passed here exist in your Chartering page HTML
                queryRAGAndDisplay(
                    charteringData, // Send the data object
                    'chartering-rag-results',        // ID of the main results container div
                    'chartering-briefing-content',   // ID of the div to put the briefing text into
                    'chartering-pdf-links-list'      // ID of the ul to put the PDF links into
                );
            }

            /**
             * Triggers RAG analysis for Input & Analysis.
             * Gathers data from the analysis parameters form.
             */
            function analyzeInputWithRAG() {
                // --- GATHER DATA FROM INPUT ANALYSIS FORM ---
                const inputData = {
                    origin_port: "N/A", // Not directly relevant here?
                    destination_port: "N/A",
                    ship_type: "Generic Vessel", // Placeholder
                    dwt: "N/A",
                    length: "N/A",
                    width: "N/A",
                    draft: "N/A",
                    fuel_type: document.getElementById('fuelType')?.value || "N/A", // Example ID, adjust if needed
                    cargo: "N/A", // Not directly relevant here?
                    timeframe: "N/A" // Could derive from startYear/lifespan?
                    // You could add custom fields for this page if the RAG pipeline supports them
                    // e.g., "analysis_type": "Fuel Strategy"
                };
                // Potentially add more contextually relevant data from the form
                const lifespan = document.getElementById('vesselLifespan')?.value;
                const discountRate = document.getElementById('discountRate')?.value;
                if (lifespan) inputData.vessel_lifespan_years = lifespan;
                if (discountRate) inputData.discount_rate_percent = discountRate;
                // --- END GATHER DATA ---

                queryRAGAndDisplay(
                    inputData,
                    'input-rag-results',
                    'input-briefing-content',
                    'input-pdf-links-list'
                );
            }

            /**
             * Triggers RAG analysis for Voyage Optimization.
             * Uses the currently selected load/discharge ports.
             */
            function analyzeVoyageWithRAG() {
                const loadPortCodeElement = document.getElementById('routeLoadPort');
                const dischargePortCodeElement = document.getElementById('routeDischargePort');

                if (!loadPortCodeElement || !dischargePortCodeElement) {
                    console.error("Voyage RAG Error: Port select elements not found.");
                    // Optionally, show an error in the voyage-rag-results section
                    const resultSection = document.getElementById('voyage-rag-results');
                    const briefingContent = document.getElementById('voyage-briefing-content');
                    if (resultSection && briefingContent) {
                        resultSection.classList.remove('hidden');
                        briefingContent.textContent = 'Error: Cannot analyze route. Port information not found.';
                    }
                    return;
                }

                const loadPortCode = loadPortCodeElement.value;
                const dischargePortCode = dischargePortCodeElement.value;

                if (!loadPortCode || !dischargePortCode || loadPortCode === dischargePortCode) {
                    console.warn("Voyage RAG Warning: Invalid port selection for analysis.");
                    // Optionally, show a warning
                    const resultSection = document.getElementById('voyage-rag-results');
                    const briefingContent = document.getElementById('voyage-briefing-content');
                    if (resultSection && briefingContent) {
                        resultSection.classList.remove('hidden');
                        briefingContent.textContent = 'Please select different origin and destination ports to analyze the route.';
                    }
                    return;
                }

                // Find port names from generatedPortDataFromJson (assuming it's loaded)
                let loadPortName = "Unknown Origin";
                let dischargePortName = "Unknown Destination";
                if (typeof generatedPortDataFromJson !== 'undefined' && Array.isArray(generatedPortDataFromJson)) {
                    const loadPortObj = generatedPortDataFromJson.find(p => p.code === loadPortCode);
                    const dischargePortObj = generatedPortDataFromJson.find(p => p.code === dischargePortCode);
                    loadPortName = loadPortObj ? loadPortObj.name : loadPortCode;
                    dischargePortName = dischargePortObj ? dischargePortObj.name : dischargePortCode;
                }

                // --- GATHER DATA FOR VOYAGE ANALYSIS ---
                const voyageData = {
                    origin_port: loadPortName,
                    destination_port: dischargePortName,
                    ship_type: "N/A", // Could infer from context if available
                    dwt: "N/A",
                    length: "N/A",
                    width: "N/A",
                    draft: "N/A",
                    fuel_type: "N/A", // Could infer from context if available
                    cargo: "N/A", // Could infer from context if available
                    timeframe: "N/A"
                    // Add a field to indicate analysis type if helpful for the RAG prompt
                    // e.g., "analysis_type": "Voyage Optimization"
                };
                // --- END GATHER DATA ---

                queryRAGAndDisplay(
                    voyageData,
                    'voyage-rag-results',
                    'voyage-briefing-content',
                    'voyage-pdf-links-list'
                );
            }

// --- END: RAG Integration Functions ---

        // Initialize application
        function init() {
            populatePortSelectors();
            updateMarketData();
            setInterval(updateMarketData, 30000);
            addBaselineFuel(); // Add initial baseline fuel
            addAlternativeScenario(); // Add initial alternative scenario
            populateYearSelectors();
            loadSeaRouteData();
            loadAcceptedPortsData();
        }
        
    </script>
</body>
</html>
